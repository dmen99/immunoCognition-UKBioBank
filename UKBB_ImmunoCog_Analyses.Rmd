---
title: "UKBB_ImmunoCog_Analyses"
author: "Daniel Mendelson"
date: "21/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
```

# 0 - Functions
## LM expression
```{r LMexpressionSandBox, echo=FALSE}
createLMExpression <- function(varNames, X, Y, M, C){
  colNumsPredictors <- c()
  for(i in c(X, M, C)){
    if(i != "ignore"){
      colNum <- which(varNames == i)
      # print(i)
      colNumsPredictors <- append(colNumsPredictors, colNum)
    }
  } # get column numbers for the relevant predictor variables

  LMpredictors <- paste(sapply(varNames[colNumsPredictors], paste), collapse = " + ")
  model <- paste(Y, " ~ ", LMpredictors, sep = "")
  return(model)
} # Input: 'varNames' - list of variable names in the dataframe to be analysed. Is given by the function colnames(df); 'Y' - name of the dependent variable; 'X' - name of the independent variable; 'M' - name of mediators mediators; 'C' - list of covariate variable names;

```

## Correlation Analyses
## Mediation Analyses

### Using package: mediation

```{r mediationFunction, echo=FALSE}
# where M: continuous mediator; X: independent variable; Y: continuous dependent variable; C: covariates
runMediation <- function(df, X, Y, M, C, mediatorModelExpression, outcomeModelExpression, control){
  require(mediation)

  # mediatorModelExpression <- createLMExpression(varNames = colnames(df), X = X, Y = M, M = NULL, C = C) # mediator model: predict M from X and C
  # outcomeModelExpression <-  createLMExpression(varNames = colnames(df), X = X, Y = Y, M = M, C = C) # outcome model: predict Y from X, M and C
  # print(mediatorModelExpression)
  # print(outcomeModelExpression)
  
   if(is.factor(X) != TRUE){
    control <- NULL
  }
  mediatorModel <- lm(eval(parse(text = mediatorModelExpression)), data = df) 
  outcomeModel <- lm(eval(parse(text = outcomeModelExpression)), data = df)
  mediation_out <- mediation::mediate(mediatorModel, outcomeModel, treat = X, control = control, mediator = M, covariates = C, boot = T)
  return(mediation_out)
} # This function runs the mediation analyses and returns the mediation model. Input: 'df' - dataframe; 'X' - name of independent variable; 'Y' - name of dependent variable; 'C' - a list of covariate variable names in string form;  'mediatorModelExpression' - the model predicting M from X and C; 'outcomeModelExpression' - the model predicting Y from X, M and C; 'treat' - the level of X to be used as the reference group, leave NULL if X is continous
```

### Using package: RMediation

```{r RMediationFunction, echo=FALSE}
# see psyc 536 lecture 5 notes
runRMediation <- function(df, X, Y, M, C){
  require(RMediation)
  
  totModelExpression <- createLMExpression(varNames = colnames(df), X = X, Y = Y, M = "", C = C) # total model: predict Y from X and C
  aPathExpression <- createLMExpression(varNames = colnames(df), X = X, Y = M, M = "", C = C) # a path model: predict M from X and C
  bPathExpression <- createLMExpression(varNames = colnames(df), X = X, Y = Y, M = M, C = C) # b path & direct path model: predict Y from X, M, and C
  
  # total effect
  totModel <- lm(eval(parse(text = totModelExpression)), data = df)
  cat("'total model' linear model expression: \n\t", totModelExpression)
  print(summary(totModel))
  
  # a path -- predict M from X
  aModel <- lm(eval(parse(text = aPathExpression)), data = df)
  cat("'a path' linear model expression: \n\t", aPathExpression)
  print(summary(aModel))
  
  # b path -- predict Y from X, M and C
  bModel <- lm(eval(parse(text = bPathExpression)), data = df)
  cat("'b path' linear model expression: \n\t", bPathExpression)
  print(summary(bModel))
  
  a <- coef(aModel)[which(names(coef(aModel)) == X)] # want coef for effect of X on M
  a.se <- coef(summary(aModel))[which(names(coef(aModel)) == X),2] # want S.E. of the regression coef of X on M. N.b. index is [row of X, column of standard errors of estimate]
  b <- coef(bModel)[which(names(coef(bModel)) == M)] # want coef for effect of M on Y
  b.se <- coefficients(summary(bModel))[which(names(coef(bModel)) == M),2] # want coef for effect of M on Y
  
  med <- medci(mu.x = a, mu.y = b, se.x = a.se, se.y = b.se, rho = 0, alpha = .05, plot = T, plotCI = T)
  return(med)
  #format output somehow
} # input: 'df' - dataframe containing all relevant variables; 'X' - name of the predictor variable; 'Y' - name of the outcome variable; 'M' - name of the mediator variable; 'C' - list of names of covariate variables
```

## Figure and table functions

### Scatterplots

```{r createPlot, echo=FALSE}
# createPlot <- function(df, x, y, xUnits, yUnits, title, loessLine, fileName){
#   require(ggplot2)
#   
#   xColNum <- which(colnames(df)==x)
#   yColNum <- which(colnames(df)==y)
#   
#   plot <- ggplot(data = df, aes(x=df[xColNum], y=df[yColNum], colour = rgb(.1,.1,.1,.7))) +
#     geom_count() +
#     labs(title = title, x = paste(x, " (", xUnits, ")"), y = paste(y, " (", yUnits, ")"))
#   
#   if(loessLine == T | loessLine == "y" | loessLine == "yes"){
#     plot <- plot + geom_smooth(method='loess')
#   }
#     
#   if(nchar(fileName) != 0){
#     fileName <- paste(fileName, ".png")
#     ggsave(fileName, width = 5, height = 5)
#   }
#   return(plot)
# } # 'df' - dataframe; 'x' - indeped var; 'y' - dep var; 'xUnits' - units of variable 'x'; 'yUnits' - units of variable 'y'; 'title' - title for the graph; 'loessLine' - logical, if the Loess line should be shown, 'fileName' - specifies name to save file to without file extension, if do not want to save, specify ""
```

```{r scatterPlotSandBox, echo=FALSE}

# createPlot(df, x=diet_rawVeg_t0, y=diet_cookedVeg_t0, xUnits = "pieces/day", yUnits = "tbsp/day", title = "CookedVeg vs rawVeg", loessLine = TRUE, fileName = "")
# 
# "diet_cookedVeg_t0"
# df$diet_cookedVeg_t0
# df$diet_rawVeg_t0
# 
# x <- 
# xUnits <- 
# y <- which(colnames(df)=="diet_cookedVeg_t0")
# yUnits <- 
# title <- "A plot"
# library(ggplot2)
# 
# plot <- ggplot(data = df, aes(x=diet_rawVeg_t0, y=diet_cookedVeg_t0, colour = rgb(.1,.1,.1,.7))) +
#     geom_count() +
#     labs(title = title, x = paste("diet_rawVeg_t0", " (", xUnits, ")"), y = paste("diet_cookedVeg_t0", " (", yUnits, ")"))
# plot <- plot + geom_smooth(method='loess')
# xlab() + ylab() + name = title

```

### Mediation diagrams

!! Needs to be revised !!

```{r medAnalysisFx, echo=FALSE}
# adapted from Omar Wasow's post on https://stackoverflow.com/questions/46465752/drawing-simple-mediation-diagram-in-r
med_data <- data.frame(
    lab_x   = "Math\\nAbility",
    lab_m   = "Math\\nself-efficacy",
    lab_y   = "Interest in the\\nmath major",
    coef_xm = ".47*",
    coef_my = ".36*",
    coef_xy = "0.33* (.16)"
  )

med_diagram <- function(data){
  
  require(glue)
  require(DiagrammeR)
  
  height = .75
  width = 2
  graph_label = NA
  node_text_size = 12
  edge_text_size = 12
  color = "black"
  ranksep = .2
  minlen = 3
  
  data$height  <- height   # node height
  data$width   <- width    # node width
  data$color   <- color    # node + edge border color
  data$ranksep <- ranksep  # separation btwn mediator row and x->y row
  data$minlen  <- minlen   # minimum edge length
  
  data$node_text_size  <- node_text_size
  data$edge_text_size  <- edge_text_size
  
  data$graph_label <- ifelse(is.na(graph_label), "", paste0("label = '", graph_label, "'"))

  diagram_out <- glue::glue_data(data,
    "digraph flowchart {
        fontname = Helvetica
        <<graph_label>>
        graph [ranksep = <<ranksep>>]
  
        # node definitions with substituted label text
        node [fontname = Helvetica, shape = rectangle, fixedsize = TRUE, width = <<width>>, height = <<height>>, fontsize = <<node_text_size>>, color = <<color>>]        
          mm [label = '<<lab_m>>']
          xx [label = '<<lab_x>>']
          yy [label = '<<lab_y>>']
  
        # edge definitions with the node IDs
        edge [minlen = <<minlen>>, fontname = Helvetica, fontsize = <<edge_text_size>>, color = <<color>>]
          mm -> yy [label = '<<coef_my>>'];
          xx -> mm [label = '<<coef_xm>>'];
          xx -> yy [label = '<<coef_xy>>'];
        
        { rank = same; mm }
        { rank = same; xx; yy }
        
        }
        ", .open = "<<", .close = ">>")  


  DiagrammeR::grViz(diagram_out)  
}

med_diagram(med_data)
```

# A - Analysis
## Import data
```{r importData, echo=FALSE}
df <- read.csv("/home/doodlefish/Documents/Research/LepageLab/immunologyAndSz/Analysis/immunoCognition/UKBB_dfForAnal_03_21_2022.csv", ) # import df
load("UKBB_dfForAnal_03_21_2022.Rdata")
df <- df[-1]

```


````{r makeOrdinal, echo=FALSE}
df <- df %>%
  mutate(crp_aliquot_fctr = factor(crp_aliquot_fctr, order = T, levels = c("Low",
                                                                           "Medium",
                                                                           "High"))) %>%
  mutate(demo_age_assess0_t0_tert = factor(demo_age_assess0_t0_tert, order = T, levels = c("[40,51)",
                                                                                           "[51,59)",
                                                                                           "[59,70]"))) %>%       
  mutate(sleep_duration0_t0_tert = factor(sleep_duration0_t0_tert, order = T, levels = c("[2, 8)",
                                                                                         "8",
                                                                                         "[9,14]"))) %>%       
  mutate(sleep_duration2_t2_tert = factor(sleep_duration2_t2_tert, order = T, levels = c("[2, 8)",
                                                                                         "8",
                                                                                         "[9,14]"))) %>%       
  mutate(cog_PC_1_tert = factor(cog_PC_1_tert, order = T, levels = c("[-0.268, 0.481)",
                                                                     "[-8.841,-0.268)",
                                                                     "[ 0.481, 2.682]"))) %>%       
  mutate(cog_PC_2_tert = factor(cog_PC_2_tert, order = T, levels = c("[-8.8376,-0.3044)",
                                                                     "[-0.3044, 0.0337)",
                                                                     "[ 0.0337,11.9452]"))) %>%       
  mutate(cog_PC_3_tert = factor(cog_PC_3_tert, order = T, levels = c("[-16.914,-0.255)",
                                                                     "[ -0.255, 0.384)",
                                                                     "[  0.384, 4.766]"))) %>%       
  mutate(smoke_currently_t0 = factor(smoke_currently_t0, order = F, levels = 
                                       c("No",
                                        "Yes"))) %>% 
  mutate(diet_processedMeat_t0 = factor(diet_processedMeat_t0, order = T, levels = 
                                          c("Never",
                                          "Less than once a week",
                                          "Once a week", 
                                          "2-4 times a week",
                                          "5-6 times a week",
                                          "Once or more daily"))) %>% 
  mutate(diet_alc_freq_t0 = factor(diet_alc_freq_t0, order = T,
                                     levels = c("Never",
                                               "Special occasions only",
                                               "One to three times a month",
                                               "Once or twice a week",
                                               "Three or four times a week",
                                               "Daily or almost daily"))) %>% 
  mutate(exercise_IPAQActivityGroup_t0 = factor(exercise_IPAQActivityGroup_t0, order = T,
                                     levels = c("low", 
                                                "moderate",
                                                "high"))) %>% 
  mutate(ses_houseIncome2_t2 = factor(ses_houseIncome2_t2, order = T, levels = c("Less than 18,000",
                                                                                 "18,000 to 30,999",
                                                                                 "31,000 to 51,999",
                                                                                 "52,000 to 100,000",
                                                                                 "Greater than 100,000"))) %>% 
  mutate(ses_houseIncome0_t0 = factor(ses_houseIncome0_t0, order = T, levels = c("Less than 18,000",
                                                                                 "18,000 to 30,999",
                                                                                 "31,000 to 51,999",
                                                                                 "52,000 to 100,000",
                                                                                 "Greater than 100,000"))) %>% 
  mutate(demo_sex_t0 = factor(demo_sex_t0)) %>% 
  mutate(hand_t0 = factor(hand_t0)) %>% 
  mutate(menopause_t0 = factor(menopause_t0)) %>% 
  mutate(smoke_ever_t0 = factor(smoke_ever_t0)) %>% 
  mutate(demo_ethnicity_t0 = factor(demo_ethnicity_t0)) %>%            
  mutate(missingEssentialVar = factor(missingEssentialVar)) %>% 
  mutate(med_SSRI0 = factor(med_SSRI0)) %>% 
  mutate(med_SSRI2 = factor(med_SSRI2)) %>% 
  mutate(med_AnyOfInterest2 = factor(med_AnyOfInterest2)) %>% 
  mutate(med_AnyOfInterest0 = factor(med_AnyOfInterest0)) %>% 
  mutate(crp_aliquot_log = log(crp_aliquot_t0))

str(df)
````
## Vars of interest
```{r importData, echo=FALSE}
crp <- which(colnames(df) == "crp_aliquot_t0")
crp_fctrCol <- which(colnames(df) == "crp_aliquot_fctr")
crp_log <-  which(colnames(df) == "crp_aliquot_log")

brainVars <- starts_with("brain_vol_", vars = colnames(df))
brainVars_z <- ends_with("_z", vars = colnames(df[brainVars]))
brainVars_z <- brainVars[brainVars_z]
brainVars_specific_z <- which(colnames(df) %in% c("brain_vol_brainSegNoVent_t2_z", "brain_vol_hippocamp_L_t2_z", "brain_vol_hippocamp_R_t2_z"))

cogPCOutputs <- starts_with("cog_PC", vars = colnames(df))
cogPCOutputs_tert <- ends_with("_tert", vars=colnames(df[cogPCOutputs]))
cogPCOutputs_tert <- cogPCOutputs[cogPCOutputs_tert]
colnames(df[cogPCOutputs])
numMemCol <- which(colnames(df) == "cog_numMem_maxDigitRemem_t2")
covars <-  which(colnames(df) %in% c("demo_sex_t0", "demo_ethnicity_t0",  "demo_age_assess0_t0_tert", "demo_daysBtwAssess", "ses_townsend_t0_tert", "med_SSRI0", "waistToHip", "diet_processedMeat_t0", "sleep_duration0_t0_tert", "sleep_duration2_t2_tert", "smoke_currently_t0", "exercise_IPAQActivityGroup_t0"))
covars_cog <- which(colnames(df) %in% c("hand_t0", "cog_hourCompleted"))

varsOfInterest <- c(crp, crp_fctrCol, crp_log, brainVars_specific_z, cogPCOutputs, numMemCol, covars, covars_cog) # list of variables used in correlation/mediation analyses
df_small <- df[c(1,varsOfInterest, which(colnames(df) == "missingEssentialVar"))]

sum(is.na(df$cog_PC_1_z))
```

````{r missingVars, echo=FALSE}

df_complete <- df_small[complete.cases(df_small), ]
nrow(df_complete)
nrow(df)

````
## correlational analyses
!!! In outputs, specify what subset of participants it is for !!!
```{r corAnalyses, echo=FALSE}
# Correlations
## Models without covariates
# x = CRP
# Y = cog
### run lms
mainCor_noC_log_cog1 <- lm(cog_PC_1_z ~ crp_aliquot_log, data = df_complete)
mainCor_noC_fctr_cog1 <- lm(cog_PC_1_z ~ crp_aliquot_fctr, data = df_complete)

mainCor_noC_log_cog2 <- lm(cog_PC_2_z ~ crp_aliquot_log, data = df_complete)
mainCor_noC_fctr_cog2 <- lm(cog_PC_2_z ~ crp_aliquot_fctr, data = df_complete)

mainCor_noC_log_cog3 <- lm(cog_PC_3_z ~ crp_aliquot_log, data = df_complete)
mainCor_noC_fctr_cog3 <- lm(cog_PC_3_z ~ crp_aliquot_fctr, data = df_complete)

### Summarise
list_models_noC_log <- c(summary(mainCor_noC_log_cog1), summary(mainCor_noC_log_cog2), summary(mainCor_noC_log_cog3)) # list of no covariate crp_log models
list_models_noC_fctr <- c(summary(mainCor_noC_fctr_cog1), summary(mainCor_noC_fctr_cog2), summary(mainCor_noC_fctr_cog3)) # list of no covariate crp_fctr models

### Plots
plot_noC_log_cog1 <- ggplot(data = df_complete, aes(x=crp_aliquot_log, y=cog_PC_1_z, colour = rgb(.1,.1,.1,.7))) + geom_count() + theme(legend.position = "none") +
                  labs(title = "Cognitive component 1 vs log(CRP)", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 1 (z score)") + 
                  geom_abline(intercept = coef(mainCor_noC_log_cog1)[1], slope = coef(mainCor_noC_log_cog1)[2])
plot_noC_log_cog2 <- ggplot(data = df_complete, aes(x=crp_aliquot_log, y=cog_PC_2_z, colour = rgb(.1,.1,.1,.7))) + geom_count() + theme(legend.position = "none") + 
                  labs(title = "Cognitive component 2 vs log(CRP)", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 2 (z score)") + 
                  geom_abline(intercept = coef(mainCor_noC_log_cog2)[1], slope = coef(mainCor_noC_log_cog2)[2])

plot_noC_log_cog3 <- ggplot(data = df_complete, aes(x=crp_aliquot_log, y=cog_PC_3_z, colour = rgb(.1,.1,.1,.7))) + geom_count() + theme(legend.position = "none") + 
                  labs(title = "Cognitive component 3 vs log(CRP)", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 3 (z score)") + 
                  geom_abline(intercept = coef(mainCor_noC_log_cog3)[1], slope = coef(mainCor_noC_log_cog3)[2])
plots_noC_log <- c(plot_noC_log_cog1, plot_noC_log_cog2, plot_noC_log_cog3)


plot_noC_fctr_cog1 <- plot(df$crp_aliquot_fctr, df$cog_PC_1_z, main = "Cognitive component 1 by CRP grouping", xlab = "CRP grouping", ylab = "Cognitive component 1 (z score)")
plot_noC_fctr_cog2 <- plot(df$crp_aliquot_log, df$cog_PC_2_z, main = "Cognitive component 2 by CRP grouping", xlab = "CRP grouping", ylab = "Cognitive component 2 (z score)")
plot_noC_fctr_cog3 <- plot(df$crp_aliquot_log, df$cog_PC_2_z, main = "Cognitive component 3 by CRP grouping", xlab = "CRP grouping", ylab = "Cognitive component 3 (z score)")
plots_noC_fctr <- c(plot_noC_fctr_cog1, plot_noC_fctr_cog2, plot_noC_fctr_cog3)

## Models with covariates
# x = CRP
# Y = cog
# C = sex, smoke, processedMeat, ethnicity, exercise, SSRI, waistToHip, daysBTWAssess, age_assess, sleep_duration, 
### Create LM expressions
withC_log_cog1 <- createLMExpression(varNames = colnames(df_complete), X = "crp_aliquot_log", C = colnames(df[covars]), M = "", Y = "cog_PC_1_z")
withC_fctr_cog1 <- createLMExpression(varNames = colnames(df_complete), X = "crp_aliquot_fctr", C = colnames(df[covars]), M = "", Y = "cog_PC_1_z")

withC_log_cog2 <- createLMExpression(varNames = colnames(df_complete), X = "crp_aliquot_log", C = colnames(df[covars]), M = "", Y = "cog_PC_2_z")
withC_fctr_cog2 <- createLMExpression(varNames = colnames(df_complete), X = "crp_aliquot_fctr", C = colnames(df[covars]), M = "", Y = "cog_PC_2_z")

withC_log_cog3 <- createLMExpression(varNames = colnames(df_complete), X = "crp_aliquot_log", C = colnames(df[covars]), M = "", Y = "cog_PC_3_z")
withC_fctr_cog3 <- createLMExpression(varNames = colnames(df_complete), X = "crp_aliquot_fctr", C = colnames(df[covars]), M = "", Y = "cog_PC_3_z")
### run lms
mainCor_C_log_cog1 <- lm(eval(parse(text = withC_log_cog1)), data = df_complete)
mainCor_C_fctr_cog1 <- lm(eval(parse(text = withC_fctr_cog1)), data = df_complete)

mainCor_C_log_cog2 <- lm(eval(parse(text = withC_log_cog2)), data = df_complete)
mainCor_C_fctr_cog2 <- lm(eval(parse(text = withC_fctr_cog2)), data = df_complete)

mainCor_C_log_cog3 <- lm(eval(parse(text = withC_log_cog3)), data = df_complete)
mainCor_C_fctr_cog3 <- lm(eval(parse(text = withC_fctr_cog3)), data = df_complete)

### Summarise
list_models_C_log <- c(withC_log_cog1, summary(mainCor_C_log_cog1), withC_log_cog2, summary(mainCor_C_log_cog2), withC_log_cog3, summary(mainCor_withC_log_cog3)) # list of covariate crp_log models. Name of the LM is included before the summary as it is passed in as a variable during the LM execution.
list_models_C_fctr <- c(withC_fctr_cog1, summary(mainCor_C_fctr_cog1), withC_fctr_cog2, summary(mainCor_C_fctr_cog2), withC_fctr_cog3, summary(mainCor_withC_fctr_cog3)) # list of no covariate crp_fctr models. Name of the LM is included before the summary as it is passed in as a variable during the LM execution
coef(mainCor_C_log_cog1)[1]

### Plots
plot_C_log_cog1 <- ggplot(data = df_complete, aes(x=crp_aliquot_log, y=cog_PC_1_z, colour = rgb(.1,.1,.1,.7))) + geom_count() + theme(legend.position = "none") +
                  labs(title = "Cognitive component 1 vs log(CRP) when controling for covariates", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 1 (z score)") + 
                  geom_abline(intercept = coef(mainCor_C_log_cog1)[1], slope = coef(mainCor_C_log_cog1)[2])
plot_C_log_cog2 <- ggplot(data = df_complete, aes(x=crp_aliquot_log, y=cog_PC_2_z, colour = rgb(.1,.1,.1,.7))) + geom_count() + theme(legend.position = "none") + 
                  labs(title = "Cognitive component 2 vs log(CRP) when controling for covariates", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 2 (z score)") + 
                  geom_abline(intercept = coef(mainCor_C_log_cog2)[1], slope = coef(mainCor_C_log_cog2)[2])

plot_C_log_cog3 <- ggplot(data = df_complete, aes(x=crp_aliquot_log, y=cog_PC_3_z, colour = rgb(.1,.1,.1,.7))) + geom_count() + theme(legend.position = "none") + 
                  labs(title = "Cognitive component 3 vs log(CRP) when controling for covariates", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 3 (z score)") + 
                  geom_abline(intercept = coef(mainCor_C_log_cog3)[1], slope = coef(mainCor_C_log_cog2)[3])
plots_C_log <- c(plot_C_log_cog1, plot_C_log_cog2, plot_C_log_cog3)


# save analysis outputs
capture.output(list_models_noC_log)
capture.output(list_models_C_log)

capture.output(list_models_noC_fctr )
capture.output(list_models_C_fctr)

```

## Mediation functions analyses

!! Will need to determine how to include covariate variables in this !! -- perhaps just include when (M \~ X) and when (Y \~ X + M) --As of March 12, 2022: uses all the covariates in the a path and the c path. See 'mediation: R package for Causal Mediation Analysis' (Tingley et al., 2014) For help with interpretation, see: PSYC 536 lab 5 script; <https://towardsdatascience.com/doing-and-reporting-your-first-mediation-analysis-in-r-2fe423b92171> \#\# Conduct analyses and return outputs

```{r sandBox, echo=FALSE}
X <- "crp_aliquot_fctr" # name of independent variable
Y <- "cog_PC_2" # name of dependent variable
M <- "brain_vol_brainSegNoVent_t2"
C <- c("demo_sex_t0", "ses_townsend_t0", "med_SSRI0", "waistToHip",  "sleep_duration0_t0", "diet_alc_freq_t0", "demo_ethnicity_t0", "diet_processedMeat_t0", "age_assess_0", "daysBtwAssess") # add "demo_age_assess_t0", a diet variable

cor.test(rank(df$crp_hourCollected), rank(df$crp_aliquot_fctr))
describe(df$crp_hourCollected)
cor.test(rank(df$crp_timeFasting_t0), rank(df$crp_aliquot_fctr))
describe(df$crp_timeFasting_t0)

cor.test(rank(df$crp_timeFasting_t0), rank(df$crp_aliquot_fctr))
describe(df$crp_timeFasting_t0)

colnames(df)
Y <- c()
for(i in C){
  colNum <- which(colnames(df) == i)
  print(paste(i, str(df[colNum])))
}

# summary(lm(eval(parse(text = mediatorModelExpression)), data = df))

mediatorModelExpression <- createLMExpression(varNames = colnames(df), X = X, Y = M, M = NULL, C = C) # mediator model: predict M from X and C
outcomeModelExpression <-  createLMExpression(varNames = colnames(df), X = X, Y = Y, M = M, C = C) # outcome model: predict Y from X, M and C
mediation_out <- runMediation(df, X = X, control = NULL, Y = Y, M = M, C = C, mediatorModelExpression = mediatorModelExpression, outcomeModelExpression = outcomeModelExpression)
summary(mediation_out)

mediation_out <- runMediation(df, X = X, control = NULL, Y = Y, M = M, C = C, mediatorModelExpression = mediatorModelExpression, outcomeModelExpression = outcomeModelExpression)

mediation_out <- runRMediation(df=df, X=X, Y=Y, M=M, C=C)

medsens(mediation_out, rho.by = .1, effect.type = "indirect")
plot(sensitivityAnalysis, sens.par = "R2", r.type = "total", sign.prod = "positive", main = M) # plots for R2. N.b. 'sign.prod', does the hypothesized confounder affect the mediator and outcome variables in the same direction or in different directions? If same then sign.prod = positive, else, = negative. See mediationR2 for details.
```

### Define model variables

```{r defineModel, echo=FALSE}
X <- "CRP_aliquot_t0" # name of independent variable
Y <- "cogGlobal" # name of dependent variable
C <- c("age_assess0", "BMI", "ses_townsend") # list of all covariate variables to control for


varNames = colnames(df)
X <- "crp_aliquot_fctr" # name of independent variable
Y <- "cog_PC_1" # name of dependent variable
M <- "brain_vol_brainSegNoVent_t2"
C <- c("demo_sex_t0", "ses_townsend_t0", "crp_hourCollected")
df$brain_vol_brainSegNoVent_t2
colNumsPredictors <- c()
for(i in c(X, M, C)){
    if(i != "ignore"){
      colNum <- which(varNames == i)
      print(i)
      colNumsPredictors <- append(colNumsPredictors, colNum)
    }
  } # get column numbers for the relevant predictor variables
which(varNames == M)
toString(paste(varNames[colNumsPredictors], "+ ", collapse = ""))
?collapse
paste(sapply(varNames[colNumsPredictors], paste), collapse = " + ")
createLMExpression(varNames, X = X, Y = Y, M = M, C = C)
runMediation(varNames, X = X, Y = Y, M = M, C = C)
```

### Run mediation analyses

!!! In outputs, specify what subset of participants it is for !!! Interpretation of mediation::mediate function summary(): ACME (average causal mediation effect): indirect effect of IV on DV through the mediator. ADE (average direct effects): direct effect of IV on DV when controlling for the mediator and covariates. Total effect: effect of IV on DV through the mediator and through other (undefined) paths Prop mediate: proportion of the effect of IV on DV mediated by M.

```{r medAnalyses, echo=FALSE}
# Mediations
## Models without covariates
model0_noC <- runMediation(df = df, X = X, Y = Y, M = "brain_vol-brainSegNoVent", covars = "") # model between CRP, whole brain volume, general cog
model1a_noC <- runMediation(df = df, X = X, Y = Y, M = "brain_vol-hippocamp-L", covars = "") # model between CRP, L hippocamp, memory
model1b_noC <- runMediation(df = df, X = X, Y = Y, M = "brain_vol-hippocamp-R", covars = "") # model between CRP, L hippocamp, memory

## Models with covariates
model0 <- runMediation(df = df, X = X, Y = Y, M = "brain_vol-brainSegNoVent", covars = C) # model between CRP, whole brain volume, general cog
model1a <- runMediation(df = df, X = X, Y = Y, M = "brain_vol-hippocamp-L", covars = C) # model between CRP, L hippocamp, memory
model1b <- runMediation(df = df, X = X, Y = Y, M = "brain_vol-hippocamp-R", covars = C) # model between CRP, L hippocamp, memory

listMedModels <- c(model0_noC, model0, model1a_noC, model1a, model1b_noC, model1b)

# Get outputs for mediation analyses
for(i in listMedModels){
  summary(i)
  medsens(i, rho.by = .1, effect.type = "indirect")
  plot(sensitivityAnalysis, sens.par = "R2", r.type = "total", sign.prod = "positive", main = M) # plots for R2. N.b. 'sign.prod', does the hypothesized confounder affect the mediator and outcome variables in the same direction or in different directions? If same then sign.prod = positive, else, = negative. See mediationR2 for details.
}
```

!! Repeat above correlation and mediation analyses for each subgroup (i.e. with and with diagnoses, drugs...) !!