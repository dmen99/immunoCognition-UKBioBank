---
title: "UKBB_ImmunoCog_Analyses"
author: "Daniel Mendelson"
date: "21/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(glmnet)
library(ggplot2)
library(car)
library(gridExtra)
library(stringr)
library(glue)
library(psych)
```

# 0 - Functions
## LM expression
```{r LMexpressionSandBox, echo=FALSE}
createLMExpression <- function(varNames, X, Y, M, C){
  colNumsPredictors <- c()
  for(i in c(X, M, C)){
    if(i != "ignore"){
      colNum <- which(varNames == i)
      # print(i)
      colNumsPredictors <- append(colNumsPredictors, colNum)
    }
  } # get column numbers for the relevant predictor variables

  LMpredictors <- paste(sapply(varNames[colNumsPredictors], paste), collapse = " + ")
  model <- paste(Y, " ~ ", LMpredictors, sep = "")
  return(model)
} # Input: 'varNames' - list of variable names in the dataframe to be analysed. Is given by the function colnames(df); 'Y' - name of the dependent variable; 'X' - name of the independent variable; 'M' - name of mediators mediators; 'C' - list of covariate variable names;

```

## Correlation Analyses
```{r corAnalysisFx, echo=FALSE}
runCor <- function(df, X, Y, M, covars, contrasts, YisFactor, name){
  expression <- createLMExpression(varNames = colnames(df), X = X, Y = Y, M = M, C = covars) # total model: predict Y from X and C  

  if(YisFactor){
    model <- glm(formula = eval(parse(text = expression)), data = df, contrasts = contrasts, family = "binomial", na.action = na.omit)
  } else {
    model <- lm(eval(parse(text = expression)), data = df, contrasts = contrasts, na.action = na.omit)
  }
  
  capture.output(
      cat(" -- Linear Model Analysis Output -- "),
      cat("\n ------------------ \n Model expression: \n\t", expression),
      print(summary(model)),
      file = paste(name, "_", date, ".txt", sep = ""))
  
  return(model)
}
```
## Mediation Analyses
### Using package: mediation

```{r mediationFunction, echo=FALSE}
# where M: continuous mediator; X: independent variable; Y: continuous dependent variable; C: covariates
runMediation <- function(df, X, Y, M, covars, mediatorModelExpression, outcomeModelExpression, control){
  require(mediation)

  # mediatorModelExpression <- createLMExpression(varNames = colnames(df), X = X, Y = M, M = NULL, C = C) # mediator model: predict M from X and C
  # outcomeModelExpression <-  createLMExpression(varNames = colnames(df), X = X, Y = Y, M = M, C = C) # outcome model: predict Y from X, M and C
  # print(mediatorModelExpression)
  # print(outcomeModelExpression)
  
   if(is.factor(X) != TRUE){
    control <- NULL
  }
  mediatorModel <- lm(eval(parse(text = mediatorModelExpression)), data = df) 
  outcomeModel <- lm(eval(parse(text = outcomeModelExpression)), data = df)
  mediation_out <- mediation::mediate(mediatorModel, outcomeModel, treat = X, control = control, mediator = M, covariates = C, boot = T)
  return(mediation_out)
} # This function runs the mediation analyses and returns the mediation model. Input: 'df' - dataframe; 'X' - name of independent variable; 'Y' - name of dependent variable; 'C' - a list of covariate variable names in string form;  'mediatorModelExpression' - the model predicting M from X and C; 'outcomeModelExpression' - the model predicting Y from X, M and C; 'treat' - the level of X to be used as the reference group, leave NULL if X is continous
```

### Using package: RMediation

```{r RMediationFunction, echo=FALSE}
# see psyc 536 lecture 5 notes
runRMediation <- function(df, X, Y, M, covars, contrasts, YisFactor, name, alpha){
  require(RMediation)
  relevantVars <- c()
  for(i in c(X, Y, M, covars)){
    if(i != ""){
      relevantVars <- c(relevantVars, i)
    }
  }
  df <- df[complete.cases(df[c(relevantVars)]),]
  totModelExpression <- createLMExpression(varNames = colnames(df), X = X, Y = Y, M = "", C = covars) # total model: predict Y from X and C
  aPathExpression <- createLMExpression(varNames = colnames(df), X = X, Y = M, M = "", C = covars) # a path model: predict M from X and C
  bPathExpression <- createLMExpression(varNames = colnames(df), X = X, Y = Y, M = M, C = covars) # b path & direct path model: predict Y from X, M, and C
  
  # total effect
  if(YisFactor == TRUE){
    totModel <- glm(eval(parse(text = totModelExpression)), data = df, contrasts = contrasts, family = "binomial")
  } else{
    totModel <- lm(eval(parse(text = totModelExpression)), data = df, contrasts = contrasts)
  }
  # a path -- predict M from X
  aModel <- lm(eval(parse(text = aPathExpression)), data = df,  contrasts = contrasts)
  
  # b path -- predict Y from X, M and C
    if(YisFactor == TRUE){
      bModel <- glm(eval(parse(text = bPathExpression)), data = df, contrasts = contrasts, family = "binomial")
    } else{
      bModel <- lm(eval(parse(text = bPathExpression)), data = df,  contrasts = contrasts)
    }
  
  a <- coef(aModel)[which(names(coef(aModel)) == X)] # want coef for effect of X on M
  a.se <- coef(summary(aModel))[which(names(coef(aModel)) == X),2] # want S.E. of the regression coef of X on M. N.b. index is [row of X, column of standard errors of estimate]
  b <- coef(bModel)[which(names(coef(bModel)) == M)] # want coef for effect of M on Y
  b.se <- coefficients(summary(bModel))[which(names(coef(bModel)) == M),2] # want coef for effect of M on Y
  
  fileName <- paste(name, "_", date, ".txt", sep = "")
  
  med <- medci(mu.x = a, mu.y = b, se.x = a.se, se.y = b.se, rho = 0, alpha = alpha, plot = F, type = "asymp")
  capture.output(
    cat(" -- Linear Model Analysis Output -- "),
    cat("\n ------------------ \n 'total model' linear model expression: \n\t", totModelExpression),
    print(summary(totModel)),
    cat("\n ------------------ \n 'a path' linear model expression: \n\t", aPathExpression),
    print(summary(aModel)),
    cat("\n ------------------ \n 'b path' linear model expression: \n\t", bPathExpression),
    print(summary(bModel)),
    cat("\n ------------------ \n Mediated Effect \n\t "),
    cat("Estimate: \t", med$Estimate, "\n\t SE:\t\t",  med$SE, "\n\t", 100*(1-alpha), "%CILow:\t", med$`97.5% CI`[1], "\n\t", 100*(1-alpha),"%CIHi:\t", med$`97.5% CI`[2],"\n"),
    file = fileName)
  
  return(fileName)
} # input: 'df' - dataframe containing all relevant variables; 'X' - name of the predictor variable; 'Y' - name of the outcome variable; 'M' - name of the mediator variable; 'C' - list of names of covariate variables; 'contrasts' - a list of ordinal variables specifying their contrasts; 'YisFactor' - if outcome is a factor, logical. If yes, logistic regression will be performed.; 'name' - name of analysis to be used for output filename; 'alpha' - critical p-value. Used for calculating confidence interval.
```

## Format RMediation function Outputs
```{r formatMedOutputFx, echo=FALSE}
formatMedOutput <- function(outputDF, filePath, fileName, analysisName, logReg){
  specificFilePath <- glue("{filePath}/{fileName}")
  fileObj <- readLines(specificFilePath)
  
  splits <- grep("~", fileObj)
  split1 <- splits[2]-2
  split2 <- splits[3]-2
  medOutput <- grep("Mediated Effect", fileObj)
  
  text_directEffect <- fileObj[2:split1]
  text_aPath <- fileObj[(split1+1):split2]
  text_bPath <- fileObj[(split2+1):(medOutput-1)]
  text_mediatedEffect <- fileObj[medOutput:length(fileObj)]
  models <- list(text_directEffect, text_aPath, text_bPath)
  
  variables <- c()
  values <- c()
  
  for(i in 1:(length(models))){ # iterate through all three models
    # Find name of mediator, indep var
    sectionText <- unlist(models[i])
    lmExpression <- grep("~", sectionText, value = TRUE) # from this line, extract analysis name
    lmExpression <- unlist(strsplit(lmExpression, "\\s+"))
    indepVar <- lmExpression[which(lmExpression == "~")-1] # n.b. indep var of this model may not be indep var of mediation analysis
    depVar <- lmExpression[which(lmExpression == "~")+1]
    
    depVarValues <- grep(depVar, sectionText, value = TRUE)
    if(length(depVarValues) == 2){
      depVarValues <- depVarValues[2]
    }
    
    depVarValues <- unlist(strsplit(depVarValues, "\\s+"))
    
    if(TRUE %in% grepl("<", depVarValues) && nchar(depVarValues[grep("<",depVarValues)]) == 1){
      pAndSymbol <- glue("{depVarValues[[5]]}{depVarValues[[6]]}")
      depVarValuesNoSigChar <- c(depVarValues[2:4], pAndSymbol)
    } else {
      depVarValuesNoSigChar <- depVarValues[2:5]
    }
    
    ########################################################33
    # bPathRows <- grep("b path", sectionText, value = TRUE)
    # if(is.null(bPathRows) == FALSE){ # extract med -> Y in b path model
    #   brainVarValues <- sectionText[starts_with("brain_", vars = sectionText)]
    #   for(i in length(brainVarValues)){
    #     splitRow <- strsplit(brainVarValues[i], "\\s+")
    #     for(j in splitRow){
    #       if(splitRow %in% listOfMediators == T){
    #         print("hi")
    #       }
    #     }
    #   }
    #   
    #   contains(brainVarValues, vars = listOfMediators)
    #   brainVarValues <- unlist(strsplit(brainVarValues, "\\s+"))
    #   if(TRUE %in% grepl("<", brainVarValues) && nchar(brainVarValues[grep("<", brainVarValues)]) == 1){
    #     pAndSymbol <- glue("{brainVarValues[[5]]}{brainVarValues[[6]]}")
    #     brainVarValuesNoSigChar <- c(brainVarValues[2:4], pAndSymbol)
    #   } else {
    #     brainVarValuesNoSigChar <- brainVarValues[2:5]
    #   }73.18
    #   df_covarsSpecificModel <- cbind(df_covarsSpecificModel,  brainVarValuesNoSigChar)
    # }
    #####################################################################333

    # listOfCovars <- c(, )
    # if(listOfCovars[1] != ""){
    #   for(covar in listOfCovars){
    #   #   covarValues <- grep(covar, sectionText, value = TRUE)
    #   #   if(is.null(covarValues) == F){
    #   #     if(length(covarValues) == 2){
    #   #       covarValues <- covarValues[2]
    #   #     }
    #   #     indexNumBegin <- length(unlist(strsplit(covar, "\\s+")))
    #   #     covarValues <- unlist(strsplit(covarValues, "\\s+"))
    #   # 
    #   #     indexOfFirstNum <- indexNumBegin + 1
    #   #     indexOfLastNum <- indexNumBegin + 4
    #   #     
    #   #     if(TRUE %in% grepl("<", covarValues)){
    #   #       indexPreP <- indexOfLastNum - 1
    #   #       covarValues <- c(covar, covarValues[indexOfFirstNum : indexPreP], glue("{covarValues[[indexOfLastNum]]}{covarValues[[indexOfLastNum+1]]}"))
    #   #     # p <- paste(FTest[[9]], FTest[[10]], sep = "")
    #   #     } else {
    #   #       covarValues <- c(covar, covarValues[indexOfFirstNum:indexOfLastNum])
    #   #     }
    #   #   } else{
    #   #     covarValues <- rep("Error, missing data.", 5)
    #   #   }
    #   #   df_covarsSpecificModel <- cbind(df_covarsSpecificModel, covarValues)
    #   # }
    #   # name <- glue("{name}_C")
    #   # if(sum(is.na(df_covarsSpecificModel[,1])) == nrow(df_covarsSpecificModel)){
    #   #     df_covarsSpecificModel <-  df_covarsSpecificModel[,-1]
    #   # }
    #   # dimnames(df_covarsSpecificModel) <- list(c(), listOfCovars)
    #   # df_covarsSpecificModel_tmp <- df_covarsSpecificModel[-1,]
    #   # df_covarsSpecificModel_tmp <- cbind("modelName" = name, "statistic" = c("parameter estimate", "SE", "t", "p"), df_covarsSpecificModel_tmp)
    #   # if(nrow(df_covarForModel) == 1){
    #   #   df_covarForModel <- rbind(df_covarForModel[-1,], df_covarsSpecificModel_tmp)
    #   # } else {
    #   #   df_covarForModel <- rbind(df_covarForModel, df_covarsSpecificModel_tmp)
    #   # }
    #   # df_covarsSpecificModel <- c()
    #   # write.csv(df_covarForModel, file = glue("{outputPrefix}_CovarWeights_{date}.csv"))
    #   }
    # } else {
    #   # name <- glue("{name}_noC")
    # }
    
    if(logReg == F || i == 2){ # the b path will always be linear regression as all brain morphology variables are continuous
      effectSizes <- grep("Multiple R-squared",sectionText, value = TRUE)
      effectSizes <- unlist(strsplit(effectSizes, "\\s+"))
      R2 <- substr(effectSizes[3], 1, nchar(effectSizes[3])-1)
      R2adj <- effectSizes[6]
      
      FTest <- grep("F-statistic",sectionText, value = TRUE)
      FTest <- unlist(strsplit(FTest, "\\s+"))
      FStat <- FTest[2]
      df1 <- FTest[4]
      df2 <- FTest[6]
      
      p <- FTest[which(FTest == grep("p-value", FTest, value = TRUE)):length(FTest)]
      if(TRUE %in% grepl("<", p) && nchar(p[grep("<",p)]) == 1){
        p <- glue("{FTest[[9]]}{FTest[[10]]}")
        # p <- paste(FTest[[9]], FTest[[10]], sep = "")
      } else {
        p <- FTest[which(FTest == grep("p-value", FTest, value = TRUE))+1]
      }
      
      if(i == 2){
        variables <- append(variables, c(indepVar, depVar))
        values <- append(values, c(depVarValuesNoSigChar, R2, R2adj, FStat, df1, df2, p))
      } else {
        AIC <- "NA"
        variables <- append(variables, c(indepVar, depVar))
        values <- append(values, c(depVarValuesNoSigChar, R2, R2adj, FStat, df1, df2, p, AIC))
      }
      
    } else{
      R2 <- "NA"
      R2adj <- "NA"
      FStat <- "NA"
      
      df <- grep("Null deviance:",sectionText, value = TRUE)
      df <- unlist(strsplit(df, "\\s+"))
      # print(df)
      df1  <- df[4] # null deviance df
      df2 <- df[6]
      
      p <- "NA"
      AIC <- grep("AIC:",sectionText, value = TRUE)
      AIC <- unlist(strsplit(AIC , "\\s+"))
      # print(AIC)
      AIC  <-  AIC[2]
  
      variables <- append(variables, c(indepVar, depVar))
      values <- append(values, c(depVarValuesNoSigChar, R2, R2adj, FStat, df1, df2, p, AIC))
    }
  }
  
  indepVar <- variables[2]
  medVar <- variables[3]
  depVar <- variables[1]
  vars <- c(indepVar, medVar, depVar)
  name <- glue("{analysisName}_{medVar}_{depVar}")
  
  # Extract indirect effect
  sectionText <- text_mediatedEffect
  
  medEff_est <- grep("Estimate",sectionText, value = TRUE)
  medEff_est <- unlist(strsplit(medEff_est, "\\s+"))
  medEff_est <-  medEff_est[3]
  
  medEff_SE <- grep("SE",sectionText, value = TRUE)
  medEff_SE <- unlist(strsplit(medEff_SE, "\\s+"))
  medEff_SE <-  medEff_SE[3]

  medEff_95Low <- grep("%CILow",sectionText, value = TRUE)
  medEff_95Low <- unlist(strsplit(medEff_95Low, "\\s+"))
  medEff_95Low <-  medEff_95Low[4]
  
  medEff_95Hi <- grep("%CIHi",sectionText, value = TRUE)
  medEff_95Hi <- unlist(strsplit(medEff_95Hi, "\\s+"))
  
  medEff_95Hi <- medEff_95Hi[4]
  
  indEff <- c(medEff_est, medEff_SE, medEff_95Low, medEff_95Hi)
  
  outputDF <- rbind(outputDF, c(name, vars, indEff, values)) # specify the indices of valueList to retain in main_df
  
  return(outputDF)
} # takes: outputDF: formatted matrix containing summary of each mediation analysis; filePath: location of text file containing mediation analysis output; fileName: name of text file containint mediation analysis; analysisName: name of analysis, e.g., 'med_noC'; logReg: logical indicates if the model is a logistic regression (i.e., discrete outcome variable)
```

# A - Analysis
## Import data
```{r importData, echo=FALSE}
date <- str_c(format(Sys.time(), "%m"), "_", format(Sys.time(), "%d"), "_", format(Sys.time(), "%Y")) # set todays date for easier output filenaming
df <- read.csv("/home/doodlefish/Documents/Research/LepageLab/immunologyAndSz/Analysis/immunoCognition-new/data/forAnalysis/UKBB_dfForAnal_All_05_05_2022.csv") # import df

# write.csv(describe(df), file = glue("UKBB_allVarSummary_{date}.csv"))
# df
# sort(colnames(df))

```

````{r makeOrdinal, echo=FALSE}
# Change var type -------------
# df <- df %>%
#   mutate(crp_aliquot_log = log(crp_aliquot_t0)) %>% 
#   mutate(crp_log_z = scale(crp_aliquot_log)) %>% 
#   mutate(cog_PC_1_z = scale(cog_PC_1)) %>% 
#   mutate(cog_PC_2_z = scale(cog_PC_2)) %>%   
#   mutate(cog_PC_3_z = scale(cog_PC_3)) %>%  
#   mutate(crp_aliquot_fctr = factor(crp_aliquot_fctr, order = T, levels = c("Low",
#                                                                            "Medium",
#                                                                            "High"))) %>%
#   mutate(demo_age_assess0_t0_tert = factor(demo_age_assess0_t0_tert, order = T, levels = c("[40,51)",
#                                                                                            "[51,59)",
#                                                                                            "[59,70]"))) %>%       
#   mutate(sleep_duration0_t0_tert = factor(sleep_duration0_t0_tert, order = T, levels = c("[2, 8)",
#                                                                                          "8",
#                                                                                          "[9,14]"))) %>%       
#   mutate(sleep_duration2_t2_tert = factor(sleep_duration2_t2_tert, order = T, levels = c("[2, 8)",
#                                                                                          "8",
#                                                                                          "[9,14]"))) %>%       
#   mutate(cog_PC_1_tert = factor(cog_PC_1_tert, order = T, levels = c("[-0.268, 0.481)",
#                                                                      "[-8.841,-0.268)",
#                                                                      "[ 0.481, 2.682]"))) %>%       
#   mutate(cog_PC_2_tert = factor(cog_PC_2_tert, order = T, levels = c("[-8.8376,-0.3044)",
#                                                                      "[-0.3044, 0.0337)",
#                                                                      "[ 0.0337,11.9452]"))) %>%       
#   mutate(cog_PC_3_tert = factor(cog_PC_3_tert, order = T, levels = c("[-16.914,-0.255)",
#                                                                      "[ -0.255, 0.384)",
#                                                                      "[  0.384, 4.766]"))) %>%       
#   mutate(smoke_currently_t0 = factor(smoke_currently_t0, order = F, levels = 
#                                        c("No",
#                                         "Yes"))) %>% 
#   mutate(diet_processedMeat_t0 = factor(diet_processedMeat_t0, order = T, levels = 
#                                           c("Never",
#                                           "Less than once a week",
#                                           "Once a week", 
#                                           "2-4 times a week",
#                                           "5-6 times a week",
#                                           "Once or more daily"))) %>% 
#   mutate(diet_alc_freq_t0 = factor(diet_alc_freq_t0, order = T,
#                                      levels = c("Never",
#                                                "Special occasions only",
#                                                "One to three times a month",
#                                                "Once or twice a week",
#                                                "Three or four times a week",
#                                                "Daily or almost daily"))) %>% 
#   mutate(exercise_IPAQActivityGroup_t0 = factor(exercise_IPAQActivityGroup_t0, order = T,
#                                      levels = c("low", 
#                                                 "moderate",
#                                                 "high"))) %>% 
#   mutate(ses_houseIncome2_t2 = factor(ses_houseIncome2_t2, order = T, levels = c("Less than 18,000",
#                                                                                  "18,000 to 30,999",
#                                                                                  "31,000 to 51,999",
#                                                                                  "52,000 to 100,000",
#                                                                                  "Greater than 100,000"))) %>% 
#   mutate(ses_houseIncome0_t0 = factor(ses_houseIncome0_t0, order = T, levels = c("Less than 18,000",
#                                                                                  "18,000 to 30,999",
#                                                                                  "31,000 to 51,999",
#                                                                                  "52,000 to 100,000",
#                                                                                  "Greater than 100,000"))) %>% 
#   mutate(demo_sex_t0 = factor(demo_sex_t0)) %>% 
#   mutate(hand_t0 = factor(hand_t0)) %>% 
#   mutate(menopause_t0 = factor(menopause_t0)) %>% 
#   mutate(smoke_ever_t0 = factor(smoke_ever_t0)) %>% 
#   mutate(demo_ethnicity_t0 = factor(demo_ethnicity_t0)) %>%            
#   mutate(missingEssentialVar = factor(missingEssentialVar)) %>% 
#   mutate(med_SSRI0 = factor(med_SSRI0)) %>% 
#   mutate(med_SSRI2 = factor(med_SSRI2)) %>% 
#   mutate(med_AnyOfInterest2 = factor(med_AnyOfInterest2)) %>% 
#   mutate(med_AnyOfInterest0 = factor(med_AnyOfInterest0))

# Scale cog vars --------
# cogPCOutputs <- starts_with("cog_PC", vars = colnames(df))

````

## Vars of interest
```{r varsOfIntDefine, echo=FALSE}
# sort(colnames(df))
crp_fctrCol <- which(colnames(df) == "crp_aliquot_fctr")
crp_log <-  which(colnames(df) == "crp_log")
crp_log_z <- which(colnames(df) == "crp_log_z")
crp <- c(which(colnames(df) == "crp_aliquot_t0"), crp_fctrCol, crp_log, crp_log_z)

brainPrefix <- c("area_","gmVol_", "GWcont_","mIntensity","mThick_", "vol_", "weigted_mFA_", "weigted_mICVF_", "weigted_mISOVF_", "weigted_mL1_", "weigted_mL2_", "weigted_mL3_", "weigted_mMD_", "weigted_mMO_", "weigted_mOD_")
brainMorphVars <- c()
for(i in brainPrefix){
  iVars <- starts_with(i, vars = colnames(df))
  # cat(paste(i, ":", length(iVars), "\n"), sep = "")
  brainMorphVars <- c(brainMorphVars, iVars)
}
brainMorphVars_colNames <- colnames(df[brainMorphVars])
df_brainMorphVarsZ <- df[brainMorphVars] %>% 
  mutate(across(.fns = scale, .names = "{colnames(df[brainMorphVars])}_z")) # standardize brain morphology variables
df_brainMorphVarsZ <- df_brainMorphVarsZ[,which(! colnames(df_brainMorphVarsZ) %in% colnames(df[brainMorphVars]))] # matrix of z-scores made in above line to add to main df
brainMorphVars_Z_colNames <- colnames(df_brainMorphVarsZ)
df <- cbind(df, df_brainMorphVarsZ[brainMorphVars_Z_colNames])
rm(df_brainMorphVarsZ)
brainMorphVars_Z_colNum <- which(colnames(df) %in% brainMorphVars_Z_colNames)
mediators <- brainMorphVars_Z_colNames

cogVars <- starts_with("cog", vars = colnames(df))
cogVars_t2_z <- cogVars[ends_with("_t2_z", vars = colnames(df[cogVars]))]
cogOutcomes_colNum <- c(cogVars_t2_z)
cogOutcomes_colNames <- colnames(df[cogOutcomes_colNum]) # list of all numeric cognitive variables to assess
prospMemCol <- which(colnames(df) == "cog_prospMem_result_t2")
cogOutcomes_fctr <- c(prospMemCol)
cogOutcomes_fctr_names <- colnames(df[cogOutcomes_fctr])

df$cog_hourCompleted_z <- scale(df$cog_hourCompleted)
covars_colNames <- c("demo_sex_t0", "demo_ethnicity_t0", "demo_age_assess0_t0_z", "demo_daysBtwAssess_z", "ses_townsend_t0_z", "weight_waistToHip_mean02_z", "sleep_duration_mean02_z", "smoke_currently0_t0", "smoke_currently2_t2","exercise_IPAQActivityGroup_t0")
covars_colNum <-  which(colnames(df) %in% covars_colNames)

covars_brain_colNames <- c("hand_t0", "brain_headScale_t2")
covars_brain_colNum <- which(colnames(df) %in% covars_brain_colNames)

essentialVarsAnalysis_colNum <- c(crp, cogOutcomes_colNum, cogOutcomes_fctr, brainMorphVars_Z_colNum, covars_colNum, covars_brain_colNum) # list of variables used in correlation/mediation analyses
essentialVarsAnalysis_colNames <- colnames(df[essentialVarsAnalysis_colNum]) 
# essentialVarsAnalysisNum <- c(crp, crp_log_z, brainMorphVars_specific_z, cogPCOutputs_z, revisedCovars, covars_brain)
# save(essentialVarsAnalysis, file = "revisedEssentialVarsAnalysis.RData")
eid <- which(colnames(df) == "eid")
missingEssVar <- which(colnames(df) == "missingEssentialVar")

df_small <- df[c(eid, essentialVarsAnalysis_colNum, missingEssVar)]
# colnames(df_small)
```

````{r missingVars, echo=FALSE}
df_complete <- df_small[complete.cases(df_small[c("ses_townsend_t0_z", "sleep_duration_mean02_z", "exercise_IPAQActivityGroup_t0")]),]
save(df_complete, file = paste("UKBB_data_corAnalyses_", date, ".csv", sep = ""))

````
## correlational analyses

### No covariates
Indep var: 'crp_log_z'; 
Outcomes: `r colnames(df[c(cogOutcomes_colNum, cogOutcomes_fctr)])`
```{r corAnalyses_noC, echo=FALSE}
individualAnalysis <- list()
mainCor_noC <- list()
analysisName <- "UKBB_Anal_cor_noC"

for(i in cogOutcomes_colNames){
  analysisName <- glue("{analysisName}_{i}")
  individualAnalysis <- runCor(df = df_complete, X = "crp_log_z", Y = i, covars = "", M = "", YisFactor = F, name = analysisName, contrasts = c())
  mainCor_noC <- c(mainCor_noC, individualAnalysis)
  # print(summary(listAnalyses_cor_noC))
  analysisName <- "UKBB_Anal_cor_noC"
}

for(i in cogOutcomes_fctr_names){
  analysisName <- glue("{analysisName}_{i}")
  individualAnalysis <- runCor(df = df_complete, X = "crp_log_z", Y = i, covars = "", M = "", YisFactor = T, name = analysisName, contrasts = c())
  mainCor_noC <- c(mainCor_noC, individualAnalysis)
  # print(summary(listAnalyses_cor_noC))
  analysisName <- "UKBB_Anal_cor_noC"
}
```

### With covariates
Indep var: 'crp_log_z'; 
Outcomes: `r colnames(df[c(cogOutcomes_colNum, cogOutcomes_fctr)])`
Covariates = `r colnames(df[covars_colNames])`
```{r corAnalyses_C, echo=FALSE}
ordinalFactorContrasts <- list(diet_processedMeat_t0 = "contr.treatment",
                               exercise_IPAQActivityGroup_t0 = "contr.treatment",
                               sleep_duration0_t0_tert = "contr.treatment",
                               ses_townsend_t0_tert = "contr.treatment",
                               demo_age_assess0_t0_tert = "contr.treatment")

individualAnalysis <- list()
mainCor_C <- list()
analysisName <- "UKBB_Anal_cor"
outputDF <- 
# for numeric variables
for(i in cogOutcomes_colNames){
  analysisName <- glue("{analysisName}_{i}")
  individualAnalysis <- runCor(df = df_small, X = "crp_log_z", Y = i, covars = colnames(df[covars_colNames]), M = "", YisFactor = F, name = analysisName, contrasts = ordinalFactorContrasts)
  mainCor_allC <- c(mainCor_C, individualAnalysis)
  capture.output(summary(individualAnalysis), file = glue("{analysisName}_{date}.txt"))
  # print(summary(listAnalyses_cor_noC))
  analysisName <- "UKBB_Anal_cor"
}

# for factor variables
for(i in cogOutcomes_fctr_names){
  analysisName <- glue("{analysisName}_{i}")
  individualAnalysis <- runCor(df = df_small, X = "crp_log_z", Y = i, covars = colnames(df[covars_colNames]), M = "", YisFactor = T, name = analysisName, contrasts = ordinalFactorContrasts)
  mainCor_allC <- c(mainCor_C, individualAnalysis)
  capture.output(summary(individualAnalysis), file = glue("{analysisName}_{date}.txt"))
  # print(summary(listAnalyses_cor_noC))
  analysisName <- "UKBB_Anal_cor"
}

```

``` {r saveCorAnalyses, echo=FALSE}
# save analysis outputs
# capture.output(mainCor_noC, file = paste("UKBB_corAnalyses_noC_", date, ".csv", sep=""))
# capture.output(mainCor_C, file = paste("UKBB_corAnalyses_C_", date, ".csv", sep=""))

```

```{r assumptionChecks, echo=FALSE}
# Correctly specified
# avPlots(PC1_allC, pt.wts = T) # if slope is 0 then the predictor is not predicting unique variance in the model. Slope of lines should be equivalent to the regression coefs in the model.
# avPlots(mainCor_C_cog2, pt.wts = T)
# avPlots(mainCor_C_cog3, pt.wts = T)
  # cat("\n \t\t Remove variable that is not predicting unique variance. Do so one at a time--excluding the one with a slope closest to 0 if applicable--and do so only at the end!")
  # !! only remove predictors at the end !!
  ###
  # plot(df_complete$demo_ethnicity_t0, df_complete$cog_PC_1_z, xlab = "", las = 3, res = 30000)
  # ggplot(df_complete, aes(reorder(demo_ethnicity_t0, -cog_PC_1_z, sum), cog_PC_1_z)) + 
  #   geom_boxplot() + 
  #   geom_jitter(position=position_jitter(.01)) +
  #   theme(axis.text.x = element_text(angle = 90), axis.line.x.top = element_line(1)) +
  #   geom_point(alpha = .15, size = 1, color = "black")
  # 
  # ggplot(data = df_complete, aes(x=demo_daysBtwAssess, y=cog_PC_1_z)) + 
  #                 geom_point(alpha = .15, size = 1, color = "black") +
  #                 theme(legend.position = "none")

```

## Mediation analyses
### No covariates
```{r medAnalyses, echo=FALSE}
individualAnalysis <- list()
listAnalyses_med_noC <- list()
mainMed_noC <- list()
analysisName <- "med_noC"
mediators <- "vol_BrainSegNotVent_WB_t2_z"
outputDF <- matrix(ncol = 40, dimnames = list(c(), c("modelName", "X", "M", "Y", "IndEff_est", "IndEff_SE", "IndEff_95%CI-Lo","IndEff_95%CI-Hi","dirEff_b", "dirEff_SE", "dirEff_X_t", "dirEff_X_p", "dirEff_R^2", "dirEff_R^2adj", "dirEff_F", "dirEff_df1", "dirEff_df2", "dirEff_p", "dirEff_AIC", "aPath_b", "aPath_SE", "aPath_X_t", "aPath_X_p", "aPath_model_R^2", "aPath_model_R^2adj", "aPath_model_F", "aPath_model_df1", "aPath_model_df2", "aPath_model_p", "bPath_b", "bPath_SE", "bPath_X_t", "bPath_X_p", "bPath_model_R^2", "bPath_model_R^2adj", "bPath_model_F", "bPath_model_df1", "bPath_model_df2", "bPath_model_p", "bPath_AIC")))


for(med in colnames(df_complete[mediators])){
  for(i in cogOutcomes_colNames){
    analysisName <- glue("UKBB_Anal_{analysisName}_{med}_{i}")
    fileName <- runRMediation(df = df_complete, X = "crp_log_z", Y = i, M = med, covars = "", contrasts = c(""), YisFactor = F, name = analysisName, alpha = .05)
    analysisName <- "med_noC"
    outputDF <- formatMedOutput(outputDF = outputDF, fileName = fileName, filePath = getwd(), analysisName = analysisName, logReg = F)
    fileToRemove <- as.character(glue("./{fileName}")) 
    file.remove(fileToRemove) # remove file
    # print(paste("indirect effect = ", round(model$Estimate, 3), " 95%CI[", round(model$`97.5% CI`[1], 3), ", ", round(model$`97.5% CI`[2], 3), "]", sep = ""))
  }
  for(i in cogOutcomes_fctr_names){
    analysisName <- glue("UKBB_Anal_{analysisName}_{med}_{i}")
    fileName <- runRMediation(df = df_complete, X = "crp_log_z", Y = i, M = med, covars = "", contrasts = c(""), YisFactor = T, name = analysisName, alpha = .05)
    analysisName <- "med_noC"
    outputDF <- formatMedOutput(outputDF = outputDF, fileName = fileName, filePath = getwd(), analysisName = analysisName,  logReg = T)
    fileToRemove <- as.character(glue("./{fileName}")) 
    file.remove(fileToRemove) # remove file
    # print(paste("indirect effect = ", round(model$Estimate, 3), " 95%CI[", round(model$`97.5% CI`[1], 3), ", ", round(model$`97.5% CI`[2], 3), "]", sep = ""))
  }
}

# as.data.frame(outputDF)
outputDF <- outputDF[-1,] # remove first row if it is all NA values
write.csv(outputDF, file = glue("UKBB_{analysisName}_results_CRPWeights_{date}.csv"))

```
Indep var: 'crp_log_z'; 
Outcomes: `r colnames(df[c(cogOoutputDF <- formatMedOutput(outputDF = outputDF, fileName = fileName, filePath = getwd(), analysisName = analysisName, logReg = F)utcomes_colNames, cogOutcomes_fctr)])`
Mediators: `r colnames(df[mediators])`; 
analysisName <- glue("UKBB_Anal_med_revC")
### With covariates
```{r medAnalyses, echo=FALSE}
covarsMed <- c(covars_colNames, covars_brain_colNames) # Add  cognition only covars
# colnames(df[covarsMed ])

individualAnalysis <- list()
listAnalyses_med_C <- list()
mainMed_C <- list()


# mediators <- c("area_Caudalanteriorcingulate_L_t2") # for testing purposes
ordinalFactorContrasts <- c()

subsetPath <- "/home/doodlefish/Documents/Research/LepageLab/immunologyAndSz/Analysis/immunoCognition-new/data/forAnalysis/Subsets"
alldfs <- c("UKBB_dfForAnal_excludingSSRI","UKBB_dfForAnal_excludingDx","UKBB_dfForAnal_onlyDx","UKBB_dfForAnal_oldestTert","UKBB_dfForAnal_onlyMedUsers","UKBB_dfForAnal_youngestTert") # list of subset names to run through
alldfs <- c("UKBB_dfForAnal_NoMedNoDx", "UKBB_dfForAnal_noMed")
alldfs <- c("UKBB_dfForAnal_NoSSRINoDx")
# alldfs <- c("UKBB_dfForAnal_excludingSSRI") # for testing purposes
subsetDate <- "05_08_2022" # date of subsets, to recreate file name

for(j in alldfs){
  subsetFileName <- glue("{j}_{subsetDate}.csv")
  subsetName <- unlist(strsplit(j, "_"))[3]
  df <- read.csv(glue("{subsetPath}/{subsetFileName}"))
  
  df_brainMorphVarsZ <- df[brainMorphVars_colNames] %>% 
    mutate(across(.fns = scale, .names = "{colnames(df[brainMorphVars])}_z")) # standardize brain morphology variables
  df_brainMorphVarsZ <- df_brainMorphVarsZ[,which(! colnames(df_brainMorphVarsZ) %in% colnames(df[brainMorphVars]))] # matrix of z-scores made in above line to add to main df
  brainMorphVars_Z_colNames <- colnames(df_brainMorphVarsZ)
  df <- cbind(df, df_brainMorphVarsZ[brainMorphVars_Z_colNames])
  mediators <- brainMorphVars_Z_colNames
  
  outputDF <- matrix(ncol = 40, dimnames = list(c(), c("modelName", "X", "M", "Y", "IndEff_est", "IndEff_SE", "IndEff_95%CI-Lo","IndEff_95%CI-Hi","dirEff_b", "dirEff_SE", "dirEff_X_t", "dirEff_X_p", "dirEff_R^2", "dirEff_R^2adj", "dirEff_F", "dirEff_df1", "dirEff_df2", "dirEff_p", "dirEff_AIC", "aPath_b", "aPath_SE", "aPath_X_t", "aPath_X_p", "aPath_model_R^2", "aPath_model_R^2adj", "aPath_model_F", "aPath_model_df1", "aPath_model_df2", "aPath_model_p", "bPath_b", "bPath_SE", "bPath_X_t", "bPath_X_p", "bPath_model_R^2", "bPath_model_R^2adj", "bPath_model_F", "bPath_model_df1", "bPath_model_df2", "bPath_model_p", "bPath_AIC")))
  
  analysisName <- glue("{subsetName}_med_C")
  
  for(med in colnames(df[mediators])){
    for(i in cogOutcomes_colNames){
      analysisName <- glue("UKBB_{analysisName}_{med}_{i}")
      fileName <- runRMediation(df = df, X = "crp_log_z", Y = i, M = med, covars = colnames(df[covarsMed]), contrasts = ordinalFactorContrasts, YisFactor = F, name = analysisName, alpha = .05)
      analysisName <- glue("{subsetName}_med_C")
      outputDF <- formatMedOutput(outputDF = outputDF, fileName = fileName, filePath = getwd(), analysisName = analysisName,  logReg = F)
      fileToRemove <- as.character(glue("./{fileName}")) 
      file.remove(fileToRemove) # remove file
    }
    for(i in cogOutcomes_fctr_names){
      analysisName <- glue("UKBB_{analysisName}_{med}_{i}")
      fileName <- runRMediation(df = df, X = "crp_log_z", Y = i, M = med, covars = colnames(df[covarsMed]), contrasts = ordinalFactorContrasts, YisFactor = T, name = analysisName, alpha = .05)
      analysisName <- glue("{subsetName}_med_C")
      outputDF <- formatMedOutput(outputDF = outputDF, fileName = fileName, filePath = getwd(), analysisName = analysisName,  logReg = T)
      fileToRemove <- as.character(glue("./{fileName}")) 
      file.remove(fileToRemove) # remove file
    }
  }
  outputDF <- as.data.frame(outputDF)
  outputDF <- outputDF[-1,] # remove first row if as it is all NA values
  write.csv(outputDF, file = glue("UKBB_{analysisName}_results_{date}.csv"))
}


```
Indep var: 'crp_log_z'; 
Outcomes: `r colnames(df[c(cogOutcomes_colNames, cogOutcomes_fctr)])`
Mediators: `r colnames(df[mediators])`; 
Covariates: `r colnames(df[covarsMed])`

# Plots & figures - !! Needs revision !!
## Correlation analyses

``` {r corPlots, echo=FALSE}
# Plots --------
## no covars --------
### Residual plots ----------
residualDf_cog1_noC <- dplyr::select(df_complete,crp_log_z,cog_PC_1_z) %>%
  dplyr::mutate(fits=fitted(mainCor_noC_cog1),
                resids=resid(mainCsubsetPathor_noC_cog1),
                sresids=rstudent(mainCor_noC_cog1))
residualPlot_cog1_noC <- ggplot(data=residualDf_cog1_noC,mapping=aes(x=fits,y=resids)) +
  labs(title = "Residual plot - Cognitive component 1 (z score) ~ log(CRP)", 
                      x = "fitted values", 
                      y = "Residual") + 
  geom_point(alpha = .15, size = 1, color = "black") +
  geom_hline(yintercept = 0,linetype="dashed")
  
residualDf_cog2_noC <- dplyr::select(df_complete,crp_log_z,cog_PC_2_z) %>%
  dplyr::mutate(fits=fitted(mainCor_noC_cog2),
                resids=resid(mainCor_noC_cog2),
                sresids=rstudent(mainCor_noC_cog2))
residualPlot_cog2_noC <- ggplot(data=residualDf_cog2_noC,mapping=aes(x=fits,y=resids)) +
  labs(title = "Residual plot - Cognitive component 2 (z score) ~ log(CRP)", 
                      x = "fitted values", 
                      y = "Residual") + 
  geom_point(alpha = .15, size = 1, color = "black") +
  geom_hline(yintercept = 0,linetype="dashed")

residualDf_cog3_noC <- dplyr::select(df_complete,crp_log_z,cog_PC_1_z) %>%
  dplyr::mutate(fits=fitted(mainCor_noC_cog1),
                resids=resid(mainCor_noC_cog1),
                sresids=rstudent(mainCor_noC_cog1))
residualPlot_cog3_noC <- ggplot(data=residualDf_cog1_noC,mapping=aes(x=fits,y=resids)) +
  labs(title = "Residual plot - Cognitive component 3 (z score) ~ log(CRP)", 
                      x = "fitted values", 
                      y = "Residual") + 
  geom_point(alpha = .15, size = 1, color = "black") +
  geom_hline(yintercept = 0,linetype="dashed")

### Scatterplots --------------
plot_noC_cog1 <- ggplot(data = df_complete, aes(x=crp_log_z, y=cog_PC_1_z, colour = rgb(.1,.1,.1,.7))) + 
                  geom_point(alpha = .15, size = 1, color = "black") +
                  labs(title = "Cognitive component 1 vs log(CRP)", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 1 (z score)") + 
                  geom_abline(intercept = coef(mainCor_noC_cog1)[1], slope = coef(mainCor_noC_cog1)[2]) + 
                  theme(legend.position = "none")
plot_noC_cog2 <- ggplot(data = df_complete, aes(x=crp_log_z, y=cog_PC_2_z)) + 
                  geom_point(alpha = .15, size = 1, color = "black") +
                  labs(title = "Cognitive component 2 vs log(CRP)", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 2 (z score)") + 
                  geom_abline(intercept = coef(mainCor_noC_cog2)[1], slope = coef(mainCor_noC_cog2)[2]) + 
                  theme(legend.position = "none")

plot_noC_cog3 <- ggplot(data = df_complete, aes(x=crp_log_z, y=cog_PC_3_z)) + 
                  geom_point(alpha = .15, size = 1, color = "black") +
                  labs(title = "Cognitive component 3 vs log(CRP)", 
                      x = "log of crp aliquot",
                      y = "Cognition component 3 (z score)") + 
                  geom_abline(intercept = coef(mainCor_noC_cog3)[1], slope = coef(mainCor_noC_cog3)[2]) + 
                  theme(legend.position = "none")
plots_noC <- c(plot_noC_cog1, plot_noC_cog2, plot_noC_cog3)

## With covars -----------
### Residual plots --------
residualDf_cog1_C <- dplyr::select(df_complete, "crp_log_z", colnames(df[covars]), "cog_PC_1_z") %>% 
  dplyr::mutate(fits=fitted(mainCor_C_cog1 ),
                resids=resid(mainCor_C_cog1 ),
                sresids=rstudent(mainCor_C_cog1 ))
residualPlot_cog1_C <- ggplot(data=residualDf_cog1_C,mapping=aes(x=fits,y=resids)) +
  labs(title = "Residual plot - Cognitive component 1 (z score) ~ log(CRP) and covariates", 
                      x = "fitted values", 
                      y = "Residual") + 
  geom_point(alpha = .15, size = 1, color = "black") +
  geom_hline(yintercept = 0,linetype="dashed")

residualDf_cog2_C <- dplyr::select(df_complete, "crp_log_z", colnames(df[covars]), "cog_PC_2_z") %>%
  dplyr::mutate(fits=fitted(mainCor_C_cog2),
                resids=resid(mainCor_C_cog2),
                sresids=rstudent(mainCor_C_cog2))
residualPlot_cog2_C <- ggplot(data=residualDf_cog2_C,mapping=aes(x=fits,y=resids)) +
  labs(title = "Residual plot - Cognitive component 2 (z score) ~ log(CRP) and covariates", 
                      x = "fitted values", 
                      y = "Residual") + 
  geom_point(alpha = .15, size = 1, color = "black") +
  geom_hline(yintercept = 0,linetype="dashed")

residualDf_cog3_C <- dplyr::select(df_complete, "crp_log_z", colnames(df[covars]), "cog_PC_3_z") %>%
  dplyr::mutate(fits=fitted(mainCor_C_cog3),
                resids=resid(mainCor_C_cog3),
                sresids=rstudent(mainCor_C_cog3))
residualPlot_cog3_C <- ggplot(data=residualDf_cog3_C,mapping=aes(x=fits,y=resids)) +
  labs(title = "Residual plot - Cognitive component 3 (z score) ~ log(CRP) and covariates", 
                      x = "fitted values", 
                      y = "Residual") + 
  geom_point(alpha = .15, size = 1, color = "black") +
  geom_hline(yintercept = 0,linetype="dashed")

residPlots_C <- c(residualPlot_cog1_C, residualPlot_cog2_C, residualPlot_cog3_C)

### Scatterplots ---------
plot_noC_cog1 <- ggplot(data = df, aes(x=crp_log, y=cog_PC_1_z))
plot_noC_cog1 <- ggplot(data = df, aes(x=crp_log, y=cog_PC_1))
sort(colnames(df))
plot(df_complete$crp_log, df_complete$cog_PC_1)
length(df_complete$cog_PC_1)
plot_C_cog1 <- ggplot(data = df_complete, aes(x=crp_aliquot_log, y=cog_PC_1_z)) + 
                  geom_point(alpha = .15, size = 1, color = "black") +
                  labs(title = "Cognitive component 1 vs log(CRP) when controling for covariates", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 1 (z score)") + 
                  geom_abline(intercept = coef(mainCor_C_cog1)[1], slope = coef(mainCor_C_cog1)[2], linetype = "dashed") +
                  theme(legend.position = "none")
plot_C_cog2 <- ggplot(data = df_complete, aes(x=crp_aliquot_log, y=cog_PC_2_z)) + 
                  geom_point(alpha = .15, size = 1, color = "black") + 
                  labs(title = "Cognitive component 2 vs log(CRP) when controling for covariates", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 2 (z score)") + 
                  geom_abline(intercept = coef(mainCor_C_cog2)[1], slope = coef(mainCor_C_cog2)[2], linetype = "dashed") +  
                  theme(legend.position = "none")
plot_C_cog3 <- ggplot(data = df_complete, aes(x=crp_aliquot_log, y=cog_PC_3_z)) + 
                  geom_point(alpha = .15, size = 1, color = "black") +
                  labs(title = "Cognitive component 3 vs log(CRP) when controling for covariates", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 3 (z score)") + 
                  geom_abline(intercept = coef(mainCor_C_cog3)[1], slope = coef(mainCor_C_cog2)[3], linetype = "dashed") +
                  theme(legend.position = "none")
plot_C_numMem <- ggplot(data = df_complete, aes(x=crp_aliquot_log, y=cog_numMem_maxDigitRemem_t2)) + 
                  geom_point(alpha = .15, size = 1, color = "black") +
                  labs(title = "Cognitive component 3 vs log(CRP) when controling for covariates", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 3 (z score)") + 
                  geom_abline(intercept = coef(mainCor_C_cog3)[1], slope = coef(mainCor_C_cog2)[3], linetype = "dashed") +
                  theme(legend.position = "none")
plots_C <- c(plot_C_cog1, plot_C_cog2, plot_C_cog3)

sum(df$crp_aliquot_t0 < 3)/dim(df)[1]

```

## Main scatter plot
```{r mainScatterplot, echo=FALSE}
# Main, lines for covariates and no covariates
ggplot(data = df_complete, aes(x=crp_log_z, y=cog_PC_1_z)) + # ideally: plot PC1 vs CRP, with 2 x-axes: one for the log value, the other for the raw CRP values; and 2 ablines: one for the model with no covars, the second with the revised covariates
                  geom_point(alpha = .3, size = 1,  color = "grey4", shape = 21) +
                  geom_abline(aes(intercept = 0, slope = -0.083709, colour="no covariates, \n b = –0.08 ***"), size = 1, alpha = .7) +
                  # geom_abline(aes(intercept = 0, slope = -0.020185, colour="with covariates, \n b = –0.02 *"), size = 1, alpha = .7) +
                  labs(color=NULL) + 
                  scale_x_continuous(
                    name = "Log of CRP (z score)",
                    position = "bottom",
                    breaks = c(-2,0,2),
                    minor_breaks = seq(-2, 2, by = 1),
                    sec.axis = sec_axis( 
                      trans = ~ exp(((.*sd(df_complete$crp_log)) + mean(df_complete$crp_log))),
                      name = "CRP serum concentration (mg/L)",
                      breaks = c(.1, .5, 1, 1.5, 2, 2.5, 3, 4, 5, 7), 
                      labels = c("0.1", "0.5", "1", "1.5", "2", "2.5", "3", "4", "5", "6")
                    )
                  ) +  
                  scale_y_continuous(
                    name = "General cognitive performance (z score)",
                    limits = c(-3,3),
                    breaks = c(-2,0,2),
                    minor_breaks = seq(from = -3, to = 3, by = 1),
                    sec.axis = dup_axis(breaks = 0, name = "")) + 
                labs(caption = glue("n = {format(nrow(df_complete), big.mark = ',')}")) +
                theme(
                  aspect.ratio = 4/7,
                  # panel.grid.major = element_blank(),
                  # panel.grid.minor = element_blank(),
                  panel.background = element_rect(fill = 'light grey'),
                  # legend.background = element_rect(fill = 'light grey'),
                  legend.key.size = unit(2, 'lines'),
                  text = element_text(family = "calibri", size = 12, colour = "black"),
                  line = element_line(colour = "black", size = .5)
                  ) + 
            # guides(fill = guide_legend(byrow = TRUE)) +
            scale_colour_brewer(palette="Set1")


# Regression line for age and CRP with covars
ggplot(data = df_complete, aes(x=demo_age_assess0_t0_z, y=cog_PC_1_z)) + # ideally: plot PC1 vs CRP, with 2 x-axes: one for the log value, the other for the raw CRP values; and 2 ablines: one for the model with no covars, the second with the revised covariates
                  geom_point(alpha = .7, size = 1,  shape = 21) +
                  geom_abline(aes(intercept = 0, slope = -0.428634, colour="age, \n b = –0.42 ***"), size = 1, alpha = .7) +
                  scale_x_continuous(
                    name = "Age (z score)",
                    position = "bottom",
                    breaks = c(-2,0,2),
                    # labels = c("-2","0", ".05", 2),
                    minor_breaks = seq(-2, 2, by = 1),
                    sec.axis = sec_axis(
                      name = "Age (years)",
                      trans = ~ ((.*7.33) + 54.02),
                      breaks = seq(from = (54.02- 2*7.33), to = (54.02 + 2*7.33), by = 7.33),
                      labels = c(round(seq(from = (54.02- 2*7.33), to = (54.02 + 2*7.33), by = 7.33),0))
                    ))+  
                geom_vline(xintercept = 0, colour = "blue") +              
                geom_vline(xintercept = 0.047, colour = "blue") +
                scale_y_continuous(
                    name = "General cognitive performance (z score)",
                    limits = c(-3,3),
                    breaks = c(-2,0,2),
                    minor_breaks = seq(from = -3, to = 3, by = 1),
                    sec.axis = dup_axis(breaks = 0, name = "")) + 
                labs(caption = glue("Increase of 0.34 years (blue lines) associated with -0.02 Z-scores of general cognitive performance. \n n = {format(nrow(df_complete), big.mark = ',')}")) +
                theme(
                  aspect.ratio = 4/7,
                  # panel.grid.major = element_blank(),
                  # panel.grid.minor = element_blank(),
                  panel.background = element_rect(fill = 'light grey'),
                  # legend.background = element_rect(fill = 'light grey'),
                  legend.key.size = unit(2, 'lines'),
                  text = element_text(family = "calibri", size = 12, colour = "black"),
                  line = element_line(colour = "black", size = .5)
                  ) + 
            # guides(fill = guide_legend(byrow = TRUE)) +
            scale_colour_brewer(palette="Set1")

hist(df_complete$crp_aliquot_t0)
hist(df_complete$crp_log)

sum(table(df_complete$crp_log))
```
