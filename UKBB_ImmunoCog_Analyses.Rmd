---
title: "UKBB_ImmunoCog_Analyses"
author: "Daniel Mendelson"
date: "21/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(car)
library(gridExtra)
library(stringr)
library(glue)
date <- str_c(format(Sys.time(), "%m"), "_", format(Sys.time(), "%d"), "_", format(Sys.time(), "%Y")) # set todays date for easier output filenaming
```

# 0 - Functions
## LM expression
```{r LMexpressionSandBox, echo=FALSE}
createLMExpression <- function(varNames, X, Y, M, C){
  colNumsPredictors <- c()
  for(i in c(X, M, C)){
    if(i != "ignore"){
      colNum <- which(varNames == i)
      # print(i)
      colNumsPredictors <- append(colNumsPredictors, colNum)
    }
  } # get column numbers for the relevant predictor variables

  LMpredictors <- paste(sapply(varNames[colNumsPredictors], paste), collapse = " + ")
  model <- paste(Y, " ~ ", LMpredictors, sep = "")
  return(model)
} # Input: 'varNames' - list of variable names in the dataframe to be analysed. Is given by the function colnames(df); 'Y' - name of the dependent variable; 'X' - name of the independent variable; 'M' - name of mediators mediators; 'C' - list of covariate variable names;

```

## Correlation Analyses
```{r corAnalysisFx, echo=FALSE}
runCor <- function(df, X, Y, M, covars, contrasts, YisFactor, name){
  expression <- createLMExpression(varNames = colnames(df), X = X, Y = Y, M = M, C = covars) # total model: predict Y from X and C  

  if(YisFactor){
    model <- glm(formula = eval(parse(text = expression)), data = df, contrasts = contrasts, family = "binomial")
  } else {
    model <- lm(eval(parse(text = expression)), data = df, contrasts = contrasts)
  }
  
  capture.output(
      cat(" -- Linear Model Analysis Output -- "),
      cat("\n ------------------ \n Model expression: \n\t", expression),
      print(summary(model)),
      file = paste(name, "_", date, ".txt", sep = ""))
  
  return(model)
}
```
## Mediation Analyses
### Using package: mediation

```{r mediationFunction, echo=FALSE}
# where M: continuous mediator; X: independent variable; Y: continuous dependent variable; C: covariates
runMediation <- function(df, X, Y, M, covars, mediatorModelExpression, outcomeModelExpression, control){
  require(mediation)

  # mediatorModelExpression <- createLMExpression(varNames = colnames(df), X = X, Y = M, M = NULL, C = C) # mediator model: predict M from X and C
  # outcomeModelExpression <-  createLMExpression(varNames = colnames(df), X = X, Y = Y, M = M, C = C) # outcome model: predict Y from X, M and C
  # print(mediatorModelExpression)
  # print(outcomeModelExpression)
  
   if(is.factor(X) != TRUE){
    control <- NULL
  }
  mediatorModel <- lm(eval(parse(text = mediatorModelExpression)), data = df) 
  outcomeModel <- lm(eval(parse(text = outcomeModelExpression)), data = df)
  mediation_out <- mediation::mediate(mediatorModel, outcomeModel, treat = X, control = control, mediator = M, covariates = C, boot = T)
  return(mediation_out)
} # This function runs the mediation analyses and returns the mediation model. Input: 'df' - dataframe; 'X' - name of independent variable; 'Y' - name of dependent variable; 'C' - a list of covariate variable names in string form;  'mediatorModelExpression' - the model predicting M from X and C; 'outcomeModelExpression' - the model predicting Y from X, M and C; 'treat' - the level of X to be used as the reference group, leave NULL if X is continous
```

### Using package: RMediation

```{r RMediationFunction, echo=FALSE}
# see psyc 536 lecture 5 notes
runRMediation <- function(df, X, Y, M, covars, contrasts, YisFactor, name){
  require(RMediation)
  
  totModelExpression <- createLMExpression(varNames = colnames(df), X = X, Y = Y, M = "", C = covars) # total model: predict Y from X and C
  aPathExpression <- createLMExpression(varNames = colnames(df), X = X, Y = M, M = "", C = covars) # a path model: predict M from X and C
  bPathExpression <- createLMExpression(varNames = colnames(df), X = X, Y = Y, M = M, C = covars) # b path & direct path model: predict Y from X, M, and C
  
  # total effect
  if(YisFactor == TRUE){
    totModel <- glm(eval(parse(text = totModelExpression)), data = df, contrasts = contrasts, family = "binomial")
  } else{
    totModel <- lm(eval(parse(text = totModelExpression)), data = df, contrasts = contrasts)
  }
  # a path -- predict M from X
  aModel <- lm(eval(parse(text = aPathExpression)), data = df,  contrasts = contrasts)
  
  # b path -- predict Y from X, M and C
    if(YisFactor == TRUE){
      bModel <- glm(eval(parse(text = bPathExpression)), data = df, contrasts = contrasts, family = "binomial")
    } else{
      bModel <- lm(eval(parse(text = bPathExpression)), data = df,  contrasts = contrasts)
    }
  
  a <- coef(aModel)[which(names(coef(aModel)) == X)] # want coef for effect of X on M
  a.se <- coef(summary(aModel))[which(names(coef(aModel)) == X),2] # want S.E. of the regression coef of X on M. N.b. index is [row of X, column of standard errors of estimate]
  b <- coef(bModel)[which(names(coef(bModel)) == M)] # want coef for effect of M on Y
  b.se <- coefficients(summary(bModel))[which(names(coef(bModel)) == M),2] # want coef for effect of M on Y
  
  med <- medci(mu.x = a, mu.y = b, se.x = a.se, se.y = b.se, rho = 0, alpha = .05, plot = T, plotCI = T, type = "asymp")
  capture.output(
    cat(" -- Linear Model Analysis Output -- "),
    cat("\n ------------------ \n 'total model' linear model expression: \n\t", totModelExpression),
    print(summary(totModel)),
    cat("\n ------------------ \n 'a path' linear model expression: \n\t", aPathExpression),
    print(summary(aModel)),
    cat("\n ------------------ \n 'b path' linear model expression: \n\t", bPathExpression),
    print(summary(bModel)),
    cat("\n ------------------ \n Mediated Effect \n\t "),
    cat("Estimate: \t", med$Estimate, "\n\t SE:\t\t",  med$SE, "\n\t 95%CILow:\t", med$`97.5% CI`[1], "\n\t 95%CIHi:\t", med$`97.5% CI`[2]),
    file = paste(name, "_", date, ".txt", sep = ""))

  return(med)
} # input: 'df' - dataframe containing all relevant variables; 'X' - name of the predictor variable; 'Y' - name of the outcome variable; 'M' - name of the mediator variable; 'C' - list of names of covariate variables; 'contrasts' - a list of ordinal variables specifying their contrasts; 'YisFactor' - if outcome is a factor, logical. If yes, logistic regression will be performed.; 'name' - name of analysis to be used for output filename
```


## Figure and table functions
### Mediation diagrams

```{r medAnalysisFx, echo=FALSE}
# adapted from Omar Wasow's post on https://stackoverflow.com/questions/46465752/drawing-simple-mediation-diagram-in-r
# med_data <- data.frame(
#     main = "Mediation title",  
#     lab_x   = "Label X",
#     lab_m   = "L:abel M",
#     lab_y   = "Label Y",
#     coef_xm = ".47*",
#     coef_my = ".36*",
#     coef_xy = "0.33* (.16)",
#     coef_indEffect = ".12"
#   )  example dataframe

med_diagram <- function(mediation_data){
  
  require(glue)
  require(DiagrammeR)
  
  height = .75
  width = 3
  graph_label = mediation_data$main
  node_text_size = 12
  edge_text_size = 12
  color = "black"
  ranksep = .2
  minlen = 3
  
  mediation_data$height  <- height   # node height
  mediation_data$width   <- width    # node width
  mediation_data$color   <- color    # node + edge border color
  mediation_data$ranksep <- ranksep  # separation btwn mediator row and x->y row
  mediation_data$minlen  <- minlen   # minimum edge length
  
  mediation_data$node_text_size  <- node_text_size
  mediation_data$edge_text_size  <- edge_text_size
  
  mediation_data$graph_label <- ifelse(is.na(graph_label), "", paste0("label = '", graph_label, "'"))

  diagram_out <- glue::glue_data(mediation_data,
    "digraph flowchart {
        fontname = Helvetica
        <<graph_label>>
        graph [ranksep = <<ranksep>>]
  
        # node definitions with substituted label text
        node [fontname = Helvetica, shape = rectangle, fixedsize = TRUE, width = <<width>>, height = <<height>>, fontsize = <<node_text_size>>, color = <<color>>]        
          mm [label = '<<lab_m>>']
          xx [label = '<<lab_x>>']
          yy [label = '<<lab_y>>']
  
        # edge definitions with the node IDs
        edge [minlen = <<minlen>>, fontname = Helvetica, fontsize = <<edge_text_size>>, color = <<color>>]
          mm -> yy [label = '<<coef_my>>'];
          xx -> mm [label = '<<coef_xm>>'];
          xx -> yy [label = '<<coef_xy>>'];
          xx -> yy [label = '<<coef_indEffect>>']
        
        { rank = same; mm }
        { rank = same; xx; yy }
        
        }
        ", .open = "<<", .close = ">>")  


  DiagrammeR::grViz(diagram_out)  
}
```

# A - Analysis
## Import data
```{r importData, echo=FALSE}
# df <- read.csv("/home/doodlefish/Documents/Research/LepageLab/immunologyAndSz/Analysis/immunoCognition/UKBB_dfForAnal_03_21_2022.csv", ) # import df
load("UKBB_dfForAnal_03_26_2022.Rdata")
# df

```

````{r makeOrdinal, echo=FALSE}
# Change var type -------------
# df <- df %>%
#   mutate(crp_aliquot_log = log(crp_aliquot_t0)) %>% 
#   mutate(crp_log_z = scale(crp_aliquot_log)) %>% 
#   mutate(cog_PC_1_z = scale(cog_PC_1)) %>% 
#   mutate(cog_PC_2_z = scale(cog_PC_2)) %>%   
#   mutate(cog_PC_3_z = scale(cog_PC_3)) %>%  
#   mutate(crp_aliquot_fctr = factor(crp_aliquot_fctr, order = T, levels = c("Low",
#                                                                            "Medium",
#                                                                            "High"))) %>%
#   mutate(demo_age_assess0_t0_tert = factor(demo_age_assess0_t0_tert, order = T, levels = c("[40,51)",
#                                                                                            "[51,59)",
#                                                                                            "[59,70]"))) %>%       
#   mutate(sleep_duration0_t0_tert = factor(sleep_duration0_t0_tert, order = T, levels = c("[2, 8)",
#                                                                                          "8",
#                                                                                          "[9,14]"))) %>%       
#   mutate(sleep_duration2_t2_tert = factor(sleep_duration2_t2_tert, order = T, levels = c("[2, 8)",
#                                                                                          "8",
#                                                                                          "[9,14]"))) %>%       
#   mutate(cog_PC_1_tert = factor(cog_PC_1_tert, order = T, levels = c("[-0.268, 0.481)",
#                                                                      "[-8.841,-0.268)",
#                                                                      "[ 0.481, 2.682]"))) %>%       
#   mutate(cog_PC_2_tert = factor(cog_PC_2_tert, order = T, levels = c("[-8.8376,-0.3044)",
#                                                                      "[-0.3044, 0.0337)",
#                                                                      "[ 0.0337,11.9452]"))) %>%       
#   mutate(cog_PC_3_tert = factor(cog_PC_3_tert, order = T, levels = c("[-16.914,-0.255)",
#                                                                      "[ -0.255, 0.384)",
#                                                                      "[  0.384, 4.766]"))) %>%       
#   mutate(smoke_currently_t0 = factor(smoke_currently_t0, order = F, levels = 
#                                        c("No",
#                                         "Yes"))) %>% 
#   mutate(diet_processedMeat_t0 = factor(diet_processedMeat_t0, order = T, levels = 
#                                           c("Never",
#                                           "Less than once a week",
#                                           "Once a week", 
#                                           "2-4 times a week",
#                                           "5-6 times a week",
#                                           "Once or more daily"))) %>% 
#   mutate(diet_alc_freq_t0 = factor(diet_alc_freq_t0, order = T,
#                                      levels = c("Never",
#                                                "Special occasions only",
#                                                "One to three times a month",
#                                                "Once or twice a week",
#                                                "Three or four times a week",
#                                                "Daily or almost daily"))) %>% 
#   mutate(exercise_IPAQActivityGroup_t0 = factor(exercise_IPAQActivityGroup_t0, order = T,
#                                      levels = c("low", 
#                                                 "moderate",
#                                                 "high"))) %>% 
#   mutate(ses_houseIncome2_t2 = factor(ses_houseIncome2_t2, order = T, levels = c("Less than 18,000",
#                                                                                  "18,000 to 30,999",
#                                                                                  "31,000 to 51,999",
#                                                                                  "52,000 to 100,000",
#                                                                                  "Greater than 100,000"))) %>% 
#   mutate(ses_houseIncome0_t0 = factor(ses_houseIncome0_t0, order = T, levels = c("Less than 18,000",
#                                                                                  "18,000 to 30,999",
#                                                                                  "31,000 to 51,999",
#                                                                                  "52,000 to 100,000",
#                                                                                  "Greater than 100,000"))) %>% 
#   mutate(demo_sex_t0 = factor(demo_sex_t0)) %>% 
#   mutate(hand_t0 = factor(hand_t0)) %>% 
#   mutate(menopause_t0 = factor(menopause_t0)) %>% 
#   mutate(smoke_ever_t0 = factor(smoke_ever_t0)) %>% 
#   mutate(demo_ethnicity_t0 = factor(demo_ethnicity_t0)) %>%            
#   mutate(missingEssentialVar = factor(missingEssentialVar)) %>% 
#   mutate(med_SSRI0 = factor(med_SSRI0)) %>% 
#   mutate(med_SSRI2 = factor(med_SSRI2)) %>% 
#   mutate(med_AnyOfInterest2 = factor(med_AnyOfInterest2)) %>% 
#   mutate(med_AnyOfInterest0 = factor(med_AnyOfInterest0))

# Scale cog vars --------
# cogPCOutputs <- starts_with("cog_PC", vars = colnames(df))
cogVars <- starts_with("cog", vars = colnames(df))
cogVars_t2 <- cogVars[ends_with("_t2", vars = colnames(df[cogVars]))]
cogVarsToZ <- cogVars_t2[which(!colnames(df[c(cogVars_t2)]) %in% c("cog_prospMem_result_t2", "cog_timeCompleted_t2", "cog_hourCompleted"))]
crp <- which(colnames(df) %in% c("crp_aliquot_t0", "crp_log"))
varsToZ <-c(crp, cogVarsToZ)

df_cog_z <- df[varsToZ] %>% 
  mutate(across(.fns = scale, .names = "{colnames(df[varsToZ])}_z"))
df <- cbind(df, df_cog_z)
df$cog_prospMem_result_t2 <- as.factor(df$cog_prospMem_result_t2)

````

## Vars of interest
```{r varsOfIntDefine, echo=FALSE}
crp <- which(colnames(df) == "crp_aliquot_t0")
crp_fctrCol <- which(colnames(df) == "crp_aliquot_fctr")
crp_log <-  which(colnames(df) == "crp_aliquot_log")
crp_log_z <- which(colnames(df) == "crp_log_z")

brainVars <- starts_with("brain_vol_", vars = colnames(df))
brainVars_z <-brainVars[ends_with("_z", vars = colnames(df[brainVars]))]
brainVars_specific_z <- which(colnames(df) %in% c("brain_vol_brainSegNoVent_t2_z", "brain_vol_hippocamp_L_t2_z", "brain_vol_hippocamp_R_t2_z"))

cogVars <- starts_with("cog", vars = colnames(df))
cogVars_t2_z <- cogVars[ends_with("_t2_z", vars = colnames(df[cogVars]))]
cogVars_t2_fctr <- which(colnames(df) %in% c("cog_prospMem_result_t2"))
cogPCOutputs <- starts_with("cog_PC", vars = colnames(df))
cogPCOutputs_tert <- cogPCOutputs[ends_with("_tert", vars=colnames(df[cogPCOutputs]))]
cogPCOutputs_z <- cogPCOutputs[ends_with("_z", vars=colnames(df[cogPCOutputs]))]
# colnames(df[cogPCOutputs_z])

numMemCol <- which(colnames(df) == "cog_numMem_maxDigitRemem_t2")
covars <-  which(colnames(df) %in% c("demo_sex_t0", "demo_ethnicity_t0", "demo_age_assess0_t0", "demo_daysBtwAssess_z", "ses_townsend_t0", "med_SSRI0", "waistToHip_z", "diet_processedMeat_t0", "sleep_duration0_t0", "smoke_currently_t0", "exercise_IPAQActivityGroup_t0"))
revisedCovars <-  which(colnames(df) %in% c("demo_sex_t0", "demo_ethnicity_t0", "demo_age_assess0_t0", "demo_daysBtwAssess_z", "ses_townsend_t0", "waistToHip_z"))
covars_brain <- which(colnames(df) %in% c("hand_t0", "cog_hourCompleted", "brain_headScale_t2"))

varsOfInterest <- c(crp, crp_fctrCol, crp_log, crp_log_z, brainVars_specific_z, cogPCOutputs, cogVars_t2_z, cogVars_t2_fctr, revisedCovars, covars_brain) # list of variables used in correlation/mediation analyses
df_small <- df[c(1,varsOfInterest, which(colnames(df) == "missingEssentialVar"))]

```

````{r missingVars, echo=FALSE}
df_complete  <- df_small
df_complete <- df_small[complete.cases(df_small), ]
cat(nrow(df) - nrow(df_complete), "cases are missing one value in one of the variables and were thus removed.")

save(df_complete, file = paste("UKBB_data_corAnalyses_", date, ".csv", sep = ""))

````
## correlational analyses

### No covariates
Indep var: 'crp_log_z'; 
Outcomes: `r colnames(df[c(cogOutcomes, cogOutcomes_fctr)])`
```{r corAnalyses_noC, echo=FALSE}
# Run models ---------------

cogOutcomes <- colnames(df[c(cogPCOutputs_z, cogVars_t2_z)])
cogOutcomes_fctr <- colnames(df[cogVars_t2_fctr])
individualAnalysis <- list()
mainCor_noC <- list()
analysisName <- "UKBB_Anal_cor_noC"

for(i in cogOutcomes){
  analysisName <- glue("{analysisName}_{i}")
  individualAnalysis <- runCor(df = df_complete, X = "crp_log_z", Y = i, covars = "", M = "", YisFactor = F, name = analysisName, contrasts = c())
  mainCor_noC <- c(mainCor_noC, individualAnalysis)
  # print(summary(listAnalyses_cor_noC))
  analysisName <- "UKBB_Anal_cor_noC"
}

for(i in cogOutcomes_fctr){
  analysisName <- glue("{analysisName}_{i}")
  individualAnalysis <- runCor(df = df_complete, X = "crp_log_z", Y = i, covars = "", M = "", YisFactor = T, name = analysisName, contrasts = c())
  mainCor_noC <- c(mainCor_noC, individualAnalysis)
  # print(summary(listAnalyses_cor_noC))
  analysisName <- "UKBB_Anal_cor_noC"
}
```

### With covariates
Indep var: 'crp_log_z'; 
Outcomes: `r colnames(df[c(cogOutcomes, cogOutcomes_fctr)])`
Covariates = `r colnames(df[revisedCovars])`
```{r corAnalyses_C, echo=FALSE}
# ordinalFactorContrasts <- list(diet_processedMeat_t0 = "contr.treatment",
#                                exercise_IPAQActivityGroup_t0 = "contr.treatment",
#                                sleep_duration0_t0_tert = "contr.treatment",
#                                ses_townsend_t0_tert = "contr.treatment",
#                                demo_age_assess0_t0_tert = "contr.treatment")

individualAnalysis <- list()
mainCor_C <- list()
analysisName <- "UKBB_Anal_cor_C"

for(i in cogOutcomes){
  analysisName <- glue("{analysisName}_{i}")
  individualAnalysis <- runCor(df = df_complete, X = "crp_log_z", Y = i, covars = colnames(df[revisedCovars]), M = "", YisFactor = F, name = analysisName, contrasts = c())
  mainCor_noC <- c(mainCor_C, individualAnalysis)
  # print(summary(listAnalyses_cor_noC))
  analysisName <- "UKBB_Anal_cor_C"
}

for(i in cogOutcomes_fctr){
  analysisName <- glue("{analysisName}_{i}")
  individualAnalysis <- runCor(df = df_complete, X = "crp_log_z", Y = i, covars = colnames(df[revisedCovars]), M = "", YisFactor = T, name = analysisName, contrasts = c())
  mainCor_noC <- c(mainCor_C, individualAnalysis)
  # print(summary(listAnalyses_cor_noC))
  analysisName <- "UKBB_Anal_cor_C"
}

```

``` {r saveCorAnalyses, echo=FALSE}
# save analysis outputs
# capture.output(mainCor_noC, file = paste("UKBB_corAnalyses_noC_", date, ".csv", sep=""))
# capture.output(mainCor_C, file = paste("UKBB_corAnalyses_C_", date, ".csv", sep=""))

```

```{r assumptionChecks, echo=FALSE}
# Correctly specified
avPlots(mainCor_C_log_cog1, pt.wts = T) # if slope is 0 then the predictor is not predicting unique variance in the model. Slope of lines should be equivalent to the regression coefs in the model.
avPlots(mainCor_C_log_cog2, pt.wts = T)
avPlots(mainCor_C_log_cog3, pt.wts = T)
  cat("\n \t\t Remove variable that is not predicting unique variance. Do so one at a time--excluding the one with a slope closest to 0 if applicable--and do so only at the end!")
  # !! only remove predictors at the end !!
  ###
  plot(df_complete$demo_ethnicity_t0, df_complete$cog_PC_1_z, xlab = "", las = 3, res = 30000)
  ggplot(df_complete, aes(reorder(demo_ethnicity_t0, -cog_PC_1_z, sum), cog_PC_1_z)) + 
    geom_boxplot() + 
    geom_jitter(position=position_jitter(.01)) +
    theme(axis.text.x = element_text(angle = 90), axis.line.x.top = element_line(1)) +
    geom_point(alpha = .15, size = 1, color = "black")
  
  ggplot(data = df_complete, aes(x=demo_daysBtwAssess, y=cog_PC_1_z)) + 
                  geom_point(alpha = .15, size = 1, color = "black") +
                  theme(legend.position = "none")

```

### With revised covariates
``` {r saveCorAnalyses, echo=FALSE}
covarsRevised1 <- which(colnames(df) %in% c("demo_sex_t0", "demo_ethnicity_t0", "demo_age_assess0_t0", "demo_daysBtwAssess_z", "waistToHip_z"))

# ordinalFactorContrasts <- list(diet_processedMeat_t0 = "contr.treatment",
#                                exercise_IPAQActivityGroup_t0 = "contr.treatment",
#                                sleep_duration0_t0_tert = "contr.treatment",
#                                ses_townsend_t0_tert = "contr.treatment",
#                                demo_age_assess0_t0_tert = "contr.treatment")

individualAnalysis <- list()
listAnalyses_cor_C <- list()
mainCor_C <- list()
for(i in cogOutcomes){
  expression <- createLMExpression(varNames = colnames(df), X = "crp_log_z", Y = i, C = colnames(df[covarsRevised1]), M = "")
  model <- lm(eval(parse(text = expression)), data = df_complete)
  listAnalyses_cor_C <- c(listAnalyses_cor_C, expression)
  individualAnalysis <- c(expression, model)
  mainCor_C <- c(mainCor_C, individualAnalysis)
  print(paste("---- ", expression, " ----", sep = ""))
  print(summary(model))
}

for(i in cogOutcomes_fctr){
  expression <- createLMExpression(varNames = colnames(df), X = "crp_log_z", Y = i, C = colnames(df[covarsRevised1]), M = "")
  model <- glm(formula = eval(parse(text = expression)), data = df_complete, family = "binomial")
  listAnalyses_cor_C <- c(listAnalyses_cor_C, expression)
  individualAnalysis <- c(expression, model)
  mainCor_C <- c(mainCor_C, individualAnalysis)
  print(paste("---- ", expression, " ----", sep = ""))
  print(summary(model))
}
```

```{r avPlots, echo=FALSE}
avPlots(mainCor_C_log_cog1, pt.wts = T) # if slope is 0 then the predictor is not predicting unique variance in the model. Slope of lines should be equivalent to the regression coefs in the model.
avPlots(mainCor_C_log_cog2, pt.wts = T)
avPlots(mainCor_C_log_cog3, pt.wts = T)

```

## Mediation analyses
### No covariates
Indep var: 'crp_log_z'; 
Outcomes: `r colnames(df[c(cogOutcomes, cogOutcomes_fctr)])`
Mediators: `r colnames(df[mediators])`; 
```{r medAnalyses, echo=FALSE}
mediators <- which(colnames(df) %in% c("brain_vol_brainSegNoVent_t2_z", "brain_vol_hippocamp_L_t2_z", "brain_vol_hippocamp_R_t2_z"))

individualAnalysis <- list()
listAnalyses_med_noC <- list()
mainMed_noC <- list()
analysisName <- "UKBB_Anal_med_noC"

for(med in colnames(df[mediators])){
  for(i in cogOutcomes){
    analysisName <- glue("{analysisName}_{med}_{i}")
    model <- runRMediation(df = df_complete, X = "crp_log_z", Y = i, M = med, covars = "", contrasts = c(""), YisFactor = F, name = analysisName)
    # mainMed_noC <- c(mainMed_noC, model)
    print(paste("indirect effect = ", round(model$Estimate, 3), " 95%CI[", round(model$`97.5% CI`[1], 3), ", ", round(model$`97.5% CI`[2], 3), "]", sep = ""))
    analysisName <- glue("UKBB_Anal_med_noC")
  }
  for(i in cogOutcomes_fctr){
     analysisName <- glue("{analysisName}_{med}_{i}")
    model <- runRMediation(df = df_complete, X = "crp_log_z", Y = i, M = med, covars = "", contrasts = c(""), YisFactor = T, name = analysisName)
    # mainMed_noC <- c(mainMed_noC, model)
    print(paste("indirect effect = ", round(model$Estimate, 3), " 95%CI[", round(model$`97.5% CI`[1], 3), ", ", round(model$`97.5% CI`[2], 3), "]", sep = ""))
    analysisName <- glue("UKBB_Anal_med_noC")
  }
}

```

### With covariates
Indep var: 'crp_log_z'; 
Outcomes: `r colnames(df[c(cogOutcomes, cogOutcomes_fctr)])`
Mediators: `r colnames(df[mediators])`; 
Covariates: `r colnames(df[covarsMed])`
```{r medAnalyses, echo=FALSE}
covarsMed <- c(covarsRevised1, covars_brain) # Add  cognition only covars

individualAnalysis <- list()
listAnalyses_med_C <- list()
mainMed_C <- list()
analysisName <- "UKBB_Anal_med_C"

for(med in colnames(df[mediators])){
  for(i in cogOutcomes){
    analysisName <- glue("{analysisName}_{med}_{i}")
    model <- runRMediation(df = df_complete, X = "crp_log_z", Y = i, M = med, covars = colnames(df[covarsMed]), contrasts = c(""), YisFactor = F, name = analysisName)
    mainMed_C <- c(mainMed_C, model)
    # print(paste("indirect effect = ", round(model$Estimate, 3), " 95%CI[", round(model$`97.5% CI`[1], 3), ", ", round(model$`97.5% CI`[2], 3), "]", sep = ""))
    analysisName <- glue("UKBB_Anal_med_C")
  }
  for(i in cogOutcomes_fctr){
    analysisName <- glue("{analysisName}_{med}_{i}")
    model <- runRMediation(df = df_complete, X = "crp_log_z", Y = i, M = med, covars = colnames(df[covarsMed]), contrasts = c(""), YisFactor = T, name = analysisName)
    mainMed_C <- c(mainMed_C, model)
    # print(paste("indirect effect = ", round(model$Estimate, 3), " 95%CI[", round(model$`97.5% CI`[1], 3), ", ", round(model$`97.5% CI`[2], 3), "]", sep = ""))
    analysisName <- glue("UKBB_Anal_med_C")
  }
}

```

# Plots & figures
## Correlation analyses
``` {r corPlots, echo=FALSE}
# Plots --------
## no covars --------
### Residual plots ----------
residualDf_cog1_noC <- dplyr::select(df_complete,crp_log_z,cog_PC_1_z) %>%
  dplyr::mutate(fits=fitted(mainCor_noC_log_cog1),
                resids=resid(mainCor_noC_log_cog1),
                sresids=rstudent(mainCor_noC_log_cog1))
residualPlot_cog1_noC <- ggplot(data=residualDf_cog1_noC,mapping=aes(x=fits,y=resids)) +
  labs(title = "Residual plot - Cognitive component 1 (z score) ~ log(CRP)", 
                      x = "fitted values", 
                      y = "Residual") + 
  geom_point(alpha = .15, size = 1, color = "black") +
  geom_hline(yintercept = 0,linetype="dashed")
  
residualDf_cog2_noC <- dplyr::select(df_complete,crp_log_z,cog_PC_2_z) %>%
  dplyr::mutate(fits=fitted(mainCor_noC_log_cog2),
                resids=resid(mainCor_noC_log_cog2),
                sresids=rstudent(mainCor_noC_log_cog2))
residualPlot_cog2_noC <- ggplot(data=residualDf_cog2_noC,mapping=aes(x=fits,y=resids)) +
  labs(title = "Residual plot - Cognitive component 2 (z score) ~ log(CRP)", 
                      x = "fitted values", 
                      y = "Residual") + 
  geom_point(alpha = .15, size = 1, color = "black") +
  geom_hline(yintercept = 0,linetype="dashed")

residualDf_cog3_noC <- dplyr::select(df_complete,crp_log_z,cog_PC_1_z) %>%
  dplyr::mutate(fits=fitted(mainCor_noC_log_cog1),
                resids=resid(mainCor_noC_log_cog1),
                sresids=rstudent(mainCor_noC_log_cog1))
residualPlot_cog3_noC <- ggplot(data=residualDf_cog1_noC,mapping=aes(x=fits,y=resids)) +
  labs(title = "Residual plot - Cognitive component 3 (z score) ~ log(CRP)", 
                      x = "fitted values", 
                      y = "Residual") + 
  geom_point(alpha = .15, size = 1, color = "black") +
  geom_hline(yintercept = 0,linetype="dashed")

### Scatterplots --------------
plot_noC_log_cog1 <- ggplot(data = df_complete, aes(x=crp_log_z, y=cog_PC_1_z, colour = rgb(.1,.1,.1,.7))) + 
                  geom_point(alpha = .15, size = 1, color = "black") +
                  labs(title = "Cognitive component 1 vs log(CRP)", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 1 (z score)") + 
                  geom_abline(intercept = coef(mainCor_noC_log_cog1)[1], slope = coef(mainCor_noC_log_cog1)[2]) + 
                  theme(legend.position = "none")
plot_noC_log_cog2 <- ggplot(data = df_complete, aes(x=crp_log_z, y=cog_PC_2_z)) + 
                  geom_point(alpha = .15, size = 1, color = "black") +
                  labs(title = "Cognitive component 2 vs log(CRP)", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 2 (z score)") + 
                  geom_abline(intercept = coef(mainCor_noC_log_cog2)[1], slope = coef(mainCor_noC_log_cog2)[2]) + 
                  theme(legend.position = "none")

plot_noC_log_cog3 <- ggplot(data = df_complete, aes(x=crp_log_z, y=cog_PC_3_z)) + 
                  geom_point(alpha = .15, size = 1, color = "black") +
                  labs(title = "Cognitive component 3 vs log(CRP)", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 3 (z score)") + 
                  geom_abline(intercept = coef(mainCor_noC_log_cog3)[1], slope = coef(mainCor_noC_log_cog3)[2]) + 
                  theme(legend.position = "none")
plots_noC_log <- c(plot_noC_log_cog1, plot_noC_log_cog2, plot_noC_log_cog3)

## With covars -----------
### Residual plots --------
residualDf_cog1_C <- dplyr::select(df_complete, "crp_log_z", colnames(df[covars]), "cog_PC_1_z") %>% 
  dplyr::mutate(fits=fitted(mainCor_C_log_cog1 ),
                resids=resid(mainCor_C_log_cog1 ),
                sresids=rstudent(mainCor_C_log_cog1 ))
residualPlot_cog1_C <- ggplot(data=residualDf_cog1_C,mapping=aes(x=fits,y=resids)) +
  labs(title = "Residual plot - Cognitive component 1 (z score) ~ log(CRP) and covariates", 
                      x = "fitted values", 
                      y = "Residual") + 
  geom_point(alpha = .15, size = 1, color = "black") +
  geom_hline(yintercept = 0,linetype="dashed")

residualDf_cog2_C <- dplyr::select(df_complete, "crp_log_z", colnames(df[covars]), "cog_PC_2_z") %>%
  dplyr::mutate(fits=fitted(mainCor_C_log_cog2),
                resids=resid(mainCor_C_log_cog2),
                sresids=rstudent(mainCor_C_log_cog2))
residualPlot_cog2_C <- ggplot(data=residualDf_cog2_C,mapping=aes(x=fits,y=resids)) +
  labs(title = "Residual plot - Cognitive component 2 (z score) ~ log(CRP) and covariates", 
                      x = "fitted values", 
                      y = "Residual") + 
  geom_point(alpha = .15, size = 1, color = "black") +
  geom_hline(yintercept = 0,linetype="dashed")

residualDf_cog3_C <- dplyr::select(df_complete, "crp_log_z", colnames(df[covars]), "cog_PC_3_z") %>%
  dplyr::mutate(fits=fitted(mainCor_C_log_cog3),
                resids=resid(mainCor_C_log_cog3),
                sresids=rstudent(mainCor_C_log_cog3))
residualPlot_cog3_C <- ggplot(data=residualDf_cog3_C,mapping=aes(x=fits,y=resids)) +
  labs(title = "Residual plot - Cognitive component 3 (z score) ~ log(CRP) and covariates", 
                      x = "fitted values", 
                      y = "Residual") + 
  geom_point(alpha = .15, size = 1, color = "black") +
  geom_hline(yintercept = 0,linetype="dashed")

residPlots_C <- c(residualPlot_cog1_C, residualPlot_cog2_C, residualPlot_cog3_C)

### Scatterplots ---------
plot_C_log_cog1 <- ggplot(data = df_complete, aes(x=crp_aliquot_log, y=cog_PC_1_z)) + 
                  geom_point(alpha = .15, size = 1, color = "black") +
                  labs(title = "Cognitive component 1 vs log(CRP) when controling for covariates", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 1 (z score)") + 
                  geom_abline(intercept = coef(mainCor_C_log_cog1)[1], slope = coef(mainCor_C_log_cog1)[2], linetype = "dashed") +
                  theme(legend.position = "none")
plot_C_log_cog2 <- ggplot(data = df_complete, aes(x=crp_aliquot_log, y=cog_PC_2_z)) + 
                  geom_point(alpha = .15, size = 1, color = "black") + 
                  labs(title = "Cognitive component 2 vs log(CRP) when controling for covariates", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 2 (z score)") + 
                  geom_abline(intercept = coef(mainCor_C_log_cog2)[1], slope = coef(mainCor_C_log_cog2)[2], linetype = "dashed") +  
                  theme(legend.position = "none")
plot_C_log_cog3 <- ggplot(data = df_complete, aes(x=crp_aliquot_log, y=cog_PC_3_z)) + 
                  geom_point(alpha = .15, size = 1, color = "black") +
                  labs(title = "Cognitive component 3 vs log(CRP) when controling for covariates", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 3 (z score)") + 
                  geom_abline(intercept = coef(mainCor_C_log_cog3)[1], slope = coef(mainCor_C_log_cog2)[3], linetype = "dashed") +
                  theme(legend.position = "none")
plot_C_log_numMem <- ggplot(data = df_complete, aes(x=crp_aliquot_log, y=cog_numMem_maxDigitRemem_t2)) + 
                  geom_point(alpha = .15, size = 1, color = "black") +
                  labs(title = "Cognitive component 3 vs log(CRP) when controling for covariates", 
                      x = "log of crp aliquot", 
                      y = "Cognition component 3 (z score)") + 
                  geom_abline(intercept = coef(mainCor_C_log_cog3)[1], slope = coef(mainCor_C_log_cog2)[3], linetype = "dashed") +
                  theme(legend.position = "none")
plots_C_log <- c(plot_C_log_cog1, plot_C_log_cog2, plot_C_log_cog3)

```

```{r medDiagrams, echo=FALSE}
# mediation diagram
med_diagram(mediation_data =  data.frame(
    main = "CRP on cog via WBV",  
    lab_x   = "crp_aliquot_log",
    lab_m   = "brain_vol_brainSegNoVent_t2_z",
    lab_y   = "cog_PC_1_z",
    coef_xm = "-.067***",
    coef_my = ".23***",
    coef_xy = "-.06*** (.16)",
    coef_indEffect = paste("indirect effect = ", round(medModel0_noC$Estimate, 3), "95%CI[", round(medModel0_noC$`97.5% CI`[1], 3), ", ", round(medModel0_noC$`97.5% CI`[2], 3), "]")))

med_diagram(mediation_data =  data.frame(
    main = "CRP on cog via WBV",  
    lab_x   = "crp_aliquot_log",
    lab_m   = "brain_vol_brainSegNoVent_t2_z",
    lab_y   = "cog_PC_1_z",
    coef_xm = "-.067***",
    coef_my = ".23***",
    coef_xy = "-.06*** (.16)",
    coef_indEffect = paste("indirect effect = ", round(medModel0_noC$Estimate, 3), "95%CI[", round(medModel0_noC$`97.5% CI`[1], 3), ", ", round(medModel0_noC$`97.5% CI`[2], 3), "]")))

```

# Analyses for crp_factor
```{r corAnalyses_CRPfctr, echo=FALSE}
# No covars ----------
## Analyses --------
# mainCor_noC_fctr_cog1 <- lm(cog_PC_1_z ~ crp_aliquot_fctr, data = df_complete, 
#                             contrasts=list(crp_aliquot_fctr = "contr.treatment"))
# mainCor_noC_fctr_cog2 <- lm(cog_PC_2_z ~ crp_aliquot_fctr, data = df_complete, 
#                             contrasts=list(crp_aliquot_fctr = "contr.treatment"))
# mainCor_noC_fctr_cog3 <- lm(cog_PC_3_z ~ crp_aliquot_fctr, data = df_complete, 
#                             contrasts=list(crp_aliquot_fctr = "contr.treatment"))

## Summarise -----
# list_models_noC_fctr <- c(summary(mainCor_noC_fctr_cog1), summary(mainCor_noC_fctr_cog2), summary(mainCor_noC_fctr_cog3)) # list of no covariate crp_fctr models

## Plots -----
# plot_noC_fctr_cog1 <- plot(df$crp_aliquot_fctr, df$cog_PC_1_z, main = "Cognitive component 1 by CRP grouping", xlab = "CRP grouping", ylab = "Cognitive component 1 (z score)")
# plot_noC_fctr_cog2 <- plot(df$crp_aliquot_fctr, df$cog_PC_2_z, main = "Cognitive component 2 by CRP grouping", xlab = "CRP grouping", ylab = "Cognitive component 2 (z score)")
# plot_noC_fctr_cog3 <- plot(df$crp_aliquot_fctr, df$cog_PC_3_z, main = "Cognitive component 3 by CRP grouping", xlab = "CRP grouping", ylab = "Cognitive component 3 (z score)")
# plots_noC_fctr <- c(plot_noC_fctr_cog1, plot_noC_fctr_cog2, plot_noC_fctr_cog3)

# With covars ------------
## Create LM expressions --------
# withC_fctr_cog1 <- createLMExpression(varNames = colnames(df_complete), X = "crp_aliquot_fctr", C = colnames(df[covars]), M = "", Y = "cog_PC_1_z")
# withC_fctr_cog2 <- createLMExpression(varNames = colnames(df_complete), X = "crp_aliquot_fctr", C = colnames(df[covars]), M = "", Y = "cog_PC_2_z")
# withC_fctr_cog3 <- createLMExpression(varNames = colnames(df_complete), X = "crp_aliquot_fctr", C = colnames(df[covars]), M = "", Y = "cog_PC_3_z")
# withC_fctr_numMem <- createLMExpression(varNames = colnames(df_complete), X = "crp_aliquot_fctr", C = colnames(df[covars]), M = "", Y = "cog_numMem_maxDigitRemem_t2")

## run lms ------
# mainCor_C_fctr_cog1 <- lm(eval(parse(text = withC_fctr_cog1)), data = df_complete, contrasts=c(crp_aliquot_fctr = "contr.treatment",ordinalFactorContrasts))
# mainCor_C_fctr_cog2 <- lm(eval(parse(text = withC_fctr_cog2)), data = df_complete, contrasts=c(crp_aliquot_fctr = "contr.treatment",ordinalFactorContrasts))
# mainCor_C_fctr_cog3 <- lm(eval(parse(text = withC_fctr_cog3)), data = df_complete, contrasts=c(crp_aliquot_fctr = "contr.treatment",ordinalFactorContrasts))
# mainCor_C_fctr_numMem <- lm(eval(parse(text = withC_fctr_numMem)), data = df_complete,contrasts=c(crp_aliquot_fctr = "contr.treatment",ordinalFactorContrasts)) 

## Summarise --------
# list_models_C_fctr <- c(withC_fctr_cog1, summary(mainCor_C_fctr_cog1), withC_fctr_cog2, summary(mainCor_C_fctr_cog2), withC_fctr_cog3, summary(mainCor_withC_fctr_cog3), withC_fctr_numMem, summary(mainCor_C_fctr_numMem)) # list of no covariate crp_fctr models. Name of the LM is included before the summary as it is passed in as a variable during the LM execution

# With revised covars --------
## Run models
mainCor_C_fctr_cog1 <- lm(eval(parse(text = withC_fctr_cog1)), data = df_complete, contrasts=c(crp_aliquot_fctr = "contr.treatment",ordinalFactorContrasts))
mainCor_C_fctr_cog2 <- lm(eval(parse(text = withC_fctr_cog2)), data = df_complete, contrasts=c(crp_aliquot_fctr = "contr.treatment",ordinalFactorContrasts))
mainCor_C_fctr_cog3 <- lm(eval(parse(text = withC_fctr_cog3)), data = df_complete, contrasts=c(crp_aliquot_fctr = "contr.treatment",ordinalFactorContrasts))
mainCor_C_fctr_numMem <- lm(eval(parse(text = withC_fctr_numMem)), data = df_complete,contrasts=c(crp_aliquot_fctr = "contr.treatment",ordinalFactorContrasts)) 
## Summarise
list_models_C_fctr <- c(withC_fctr_cog1, summary(mainCor_C_fctr_cog1), withC_fctr_cog2, summary(mainCor_C_fctr_cog2), withC_fctr_cog3, summary(mainCor_withC_fctr_cog3), withC_fctr_numMem, summary(mainCor_C_fctr_numMem)) # list of no covariate crp_fctr models. Name of the LM is included before the summary as it is passed in as a variable during the LM execution

## Capture outputs ------
# capture.output(list_models_noC_fctr)
# capture.output(list_models_C_fctr)
```
